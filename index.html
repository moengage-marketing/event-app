<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Attendee Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .copy-feedback { font-size: 0.75rem; color: #10B981; margin-left: 8px; display: inline-block; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .side-by-side-charts .chart-container { max-width: 100%; }

        /* Styling for "Demo Requested" state */
        .demo-requested-active { background-color: #cffde3 !important; }
        .demo-requested-row-active { background-color: #cffde3; }
        .demo-requested-row-active:hover { background-color: #b6f7d0 !important; }
        
        .attendee-count-text { color: #16484d; }
        .info-icon { cursor: help; color: #60a5fa; margin-left: 4px; }
        .tooltip { visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 130%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .info-icon-container:hover .tooltip { visibility: visible; opacity: 1; }
        
        .grid-tile { background-color: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; display: flex; flex-direction: column; justify-content: space-between; height: 100%;}
        .grid-tile:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .grid-tile img { max-height: 100px; object-fit: contain; margin-bottom: 0.5rem; margin-left: auto; margin-right: auto;}
        
        /* Notification Toast Styling */
        #notificationToast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; z-index: 200; transition: top 0.5s ease-in-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #notificationToast.show { top: 20px; }
        .bg-success { background-color: #10B981; } .bg-error { background-color: #EF4444; } .bg-info { background-color: #3B82F6; }
        
        /* Spinner for loading states */
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Notification Toast -->
    <div id="notificationToast"></div>

    <!-- Welcome Screen / Initial Login -->
    <div id="welcomeScreen" class="fixed inset-0 bg-gray-100 z-[100] flex flex-col items-center justify-center p-8">
        <img src="https://info.moengage.com/hubfs/MoEvents.png" alt="Event Banner" class="max-w-56 md:max-w-xs h-auto mx-auto rounded-lg mb-12" onerror="this.onerror=null; this.src='https://placehold.co/400x150/cccccc/333333?text=Event+Banner';">
        <div id="initialLoginOptions" class="w-full max-w-sm">
            <div id="userNamePrompt">
                <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-1">Enter your first name</label>
                <input type="text" id="userNameInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Your First Name">
                <button id="enterAppButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all mb-3">Enter</button>
            </div>
            <div id="returningUserOptions" class="hidden">
                <p id="welcomeBackMessage" class="text-lg text-gray-700 mb-4 text-center"></p>
                <button id="viewEventsButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all mb-3">View Events</button>
            </div>
            <button id="adminControlsLoginButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">Admin Controls</button>
        </div>
    </div>

    <!-- Admin Login Screen -->
    <div id="adminLoginScreen" class="fixed inset-0 bg-gray-100 z-[90] flex flex-col items-center justify-center p-8 hidden">
        <img src="https://info.moengage.com/hubfs/MoEvents.png" alt="Event Banner" class="max-w-56 md:max-w-xs h-auto mx-auto rounded-lg mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Admin Login</h2>
        <div class="w-full max-w-sm bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label for="adminUsername" class="block text-sm font-medium text-gray-700">Username</label>
                <select id="adminUsername" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="mb-6">
                <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="adminPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button id="adminLoginSubmitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Submit</button>
            <button id="backToWelcomeFromAdminLoginButton" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Back</button>
        </div>
    </div>

    <!-- Admin Controls Page -->
    <div id="adminControlsScreen" class="container mx-auto p-4 md:p-8 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Admin Controls</h1>
            <button id="adminLogoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Logout</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="addEventTile" class="grid-tile">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-calendar-plus mx-auto mb-2 text-indigo-600" viewBox="0 0 16 16"><path d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>
                <h3 class="text-xl font-semibold text-gray-800">Add Event</h3>
                <p class="text-sm text-gray-600">Create a new event profile.</p>
            </div>
            <div id="manageEventsTile" class="grid-tile">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-pencil-square mx-auto mb-2 text-indigo-600" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.636a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.813z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                <h3 class="text-xl font-semibold text-gray-800">Manage Events</h3>
                <p class="text-sm text-gray-600">View, edit, or delete existing events.</p>
            </div>
        </div>
    </div>
    
    <div id="eventSelectionScreen" class="container mx-auto p-4 md:p-8 hidden">
         <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Select an Event</h1>
            <button id="userLogoutButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Change User</button>
        </div>
        <div id="eventTilesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
         <p id="noEventsToShowMessage" class="text-center text-gray-500 py-10 hidden">No events available at the moment. Please check back later.</p>
    </div>

    <div id="mainAppContent" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-6 text-center">
            <img id="eventSpecificBanner" src="https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" alt="Event Banner" class="max-w-xs h-auto mx-auto rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';">
        </header>
        <button id="backToEventSelectionButton" class="mb-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">&larr; Back to Events</button>
        <main class="bg-white p-6 rounded-lg shadow-xl">
            <h1 id="eventSpecificTitle" class="text-2xl md:text-3xl font-bold text-gray-700 mb-2 text-center">Event Name</h1>
            <div id="attendeeStatusDisplay" class="text-center mb-6 p-3 rounded-lg attendee-count-text">
                <span id="eventStatusIndicator" class="inline-block w-3 h-3 rounded-full mr-2 hidden"></span>
                <span id="homeScreenTotalAttendeesCount" class="text-2xl font-bold">0</span>
                <span class="text-xl"> checked-in attendees</span>
            </div>
            
            <div class="flex flex-col space-y-4 mb-6">
                <div class="relative w-full">
                    <input type="text" id="searchInput"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                           placeholder="Search by name, company, or job title...">
                    <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="flex space-x-2 md:space-x-4 w-full md:w-auto md:justify-start">
                     <button id="filterButton" style="background-color: #0abc58;" class="w-1/2 md:w-auto hover:opacity-90 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center text-sm">
                        <svg class="h-5 w-5 mr-1 md:mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" /></svg>
                        Filters
                    </button>
                    <button id="metricsButton" style="background-color: #16484d;" class="w-1/2 md:w-auto hover:opacity-90 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center text-sm">
                        <svg class="h-5 w-5 mr-1 md:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        Metrics
                    </button>
                </div>
            </div>

            <div id="loadingSpinner" class="text-center py-10 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                <p class="text-gray-600 mt-2">Loading attendees...</p>
            </div>
            <div id="errorMessage" class="text-center py-10 hidden bg-red-100 text-red-700 p-4 rounded-lg">
                <p id="errorText"></p>
                <button id="retryFetchButton" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Retry
                </button>
            </div>

            <div id="attendeesTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm table-fixed">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="w-[20%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
                <p id="noAttendeesMessage" class="text-center text-gray-500 py-10 hidden">No attendees checked in yet.</p>
            </div>
        </main>

        <div id="attendeeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="attendeeModalContent" class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Details</h3>
                    <button id="closeAttendeeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalBody" class="p-6 space-y-3 flex-grow overflow-y-auto">
                    <!-- Attendee details will be populated here -->
                </div>
                <!-- Conversations/Notes Section -->
                <div id="conversationSection" class="p-6 border-t border-gray-200 flex-shrink-0">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Conversations</h4>
                    <div id="conversationNoteDisplay" class="p-3 bg-gray-100 rounded-lg text-sm text-gray-800 whitespace-pre-wrap"></div>
                    <div id="conversationNoteActions" class="mt-2 text-right"></div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                     <button id="demoRequestedButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <span id="demoRequestedButtonText">Demo Requested</span>
                        <span id="demoRequestedCheckmark" class="ml-2 hidden">âœ“</span>
                    </button>
                     <button id="closeAttendeeModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <!-- Conversation Note Modal -->
        <div id="conversationNoteModal" class="fixed inset-0 z-[150] flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Edit Conversation Note</h3>
                    <button id="closeConversationNoteModalButton" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="p-6">
                    <textarea id="conversationNoteInput" class="w-full p-2 border border-gray-300 rounded-md shadow-sm h-40" placeholder="Enter your private notes here..."></textarea>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between">
                    <button id="deleteConversationNoteButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Delete</button>
                    <div class="space-x-3">
                        <button id="cancelConversationNoteButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                        <button id="submitConversationNoteButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="filterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Filter Attendees</h3>
                    <button id="closeFilterModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="filterType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Prospect">Prospect</option> <option value="Partner">Partner</option> <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterFocusAccount" class="block text-sm font-medium text-gray-700 mb-1">Focus Account</label>
                        <select id="filterFocusAccount" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Yes">Yes</option> <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAE" class="block text-sm font-medium text-gray-700 mb-1">On-ground AE</label>
                        <select id="filterAE" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All AEs</option></select>
                    </div>
                    <div>
                        <label for="filterSDR" class="block text-sm font-medium text-gray-700 mb-1">On-ground SDR</label>
                         <select id="filterSDR" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All SDRs</option></select>
                    </div>
                    </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="clearFiltersButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">Clear Filters</button>
                    <button id="applyFiltersButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Apply Filters</button>
                </div>
            </div>
        </div>

        <div id="metricsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Metrics</h3>
                    <button id="closeMetricsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-6 flex-grow overflow-y-auto">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700">Total Checked-in: <span id="totalAttendeesCount" class="text-blue-600">0</span></h4>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts">
                        <div class="md:w-1/2 chart-container">
                             <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by SDR</h4>
                            <canvas id="sdrChart"></canvas>
                        </div>
                        <div class="md:w-1/2 chart-container">
                            <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by AE</h4>
                            <canvas id="aeChart"></canvas>
                        </div>
                    </div>
                     <div class="flex flex-col md:flex-row justify-center md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts mt-10">
                        <div class="md:w-1/2 chart-container"> <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by Type</h4>
                            <canvas id="attendeeTypeChart"></canvas>
                        </div>
                        </div>
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Demo Requests</h4>
                        <div id="demoRequestsTableContainer" class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                    </tr>
                                </thead>
                                <tbody id="demoRequestsTableBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                            <p id="noDemoRequestsMessage" class="text-center text-gray-500 py-6 hidden">No demo requests yet.</p>
                        </div>
                        <div class="mt-4 text-center">
                             <button id="downloadDemoRequestsCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Download Demo Requests CSV</button>
                        </div>
                    </div>

                    <!-- Conversations Table Section -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Conversation Notes</h4>
                        <div id="conversationsTableContainer" class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated By</th>
                                    </tr>
                                </thead>
                                <tbody id="conversationsTableBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                            <p id="noConversationsMessage" class="text-center text-gray-500 py-6 hidden">No conversations recorded yet.</p>
                        </div>
                        <div class="mt-4 text-center">
                             <button id="downloadConversationsCsvButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Download Conversations CSV</button>
                        </div>
                    </div>

                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 text-right flex-shrink-0">
                     <button id="closeMetricsModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="addEventModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Add New Event</h3>
                    <button id="closeAddEventModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="addEventForm" class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="eventName" class="block text-sm font-medium text-gray-700">Event Name 
                            <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Add the public name of the event</span>
                            </span>
                        </label>
                        <input type="text" id="eventName" name="eventName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventCity" class="block text-sm font-medium text-gray-700">City
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Enter the city where the event is held.</span>
                            </span>
                        </label>
                        <input type="text" id="eventCity" name="eventCity" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">Event Date
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Select the date of the event.</span>
                            </span>
                        </label>
                        <input type="date" id="eventDate" name="eventDate" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventStartTime" class="block text-sm font-medium text-gray-700">Event Start Time
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Add the same start time as on the LP.</span>
                            </span>
                        </label>
                        <input type="time" id="eventStartTime" name="eventStartTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventEndTime" class="block text-sm font-medium text-gray-700">Event End Time
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Enter the end time of the event.</span>
                            </span>
                        </label>
                        <input type="time" id="eventEndTime" name="eventEndTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventSheetUrl" class="block text-sm font-medium text-gray-700">Source Sheet URL
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Paste the URL you receive after File > Share > Publish to Web in your Google Sheet (CSV output).</span>
                            </span>
                        </label>
                        <input type="url" id="eventSheetUrl" name="eventSheetUrl" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventBannerUrl" class="block text-sm font-medium text-gray-700">Event Banner Image URL
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Paste the public URL after uploading the transparent logo image on Hubspot.</span>
                            </span>
                        </label>
                        <input type="url" id="eventBannerUrl" name="eventBannerUrl" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </form>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="submitAddEventButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Submit Event</button>
                </div>
            </div>
        </div>

        <div id="manageEventsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Manage Events</h3>
                    <button id="closeManageEventsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="manageEventDropdown" class="block text-sm font-medium text-gray-700 mb-1">Select Event to Manage</label>
                        <select id="manageEventDropdown" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                    <button id="deleteEventButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg mt-4">Delete Selected Event</button>
                </div>
                 <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="doneManageEventsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Done</button>
                </div>
            </div>
        </div>
        
        <!-- Custom Confirmation Modal -->
        <div id="customConfirmModal" class="fixed inset-0 z-[150] flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6">
                <h3 id="customConfirmTitle" class="text-lg font-semibold text-gray-800 mb-4">Confirm Action</h3>
                <p id="customConfirmMessage" class="text-sm text-gray-600 mb-6">Are you sure?</p>
                <div class="flex justify-end space-x-3">
                    <button id="customConfirmCancelButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="customConfirmOkButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
                </div>
            </div>
        </div>


    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, writeBatch, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const POLLING_INTERVAL = 30000; 
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://thingproxy.freeboard.io/fetch/'
        ];
        
        // --- DOM Elements ---
        const screens = { welcome: document.getElementById('welcomeScreen'), adminLogin: document.getElementById('adminLoginScreen'), adminControls: document.getElementById('adminControlsScreen'), eventSelection: document.getElementById('eventSelectionScreen'), mainApp: document.getElementById('mainAppContent')};
        const userNameInput = document.getElementById('userNameInput');
        const enterAppButton = document.getElementById('enterAppButton');
        const searchInput = document.getElementById('searchInput');
        const filterButton = document.getElementById('filterButton');
        const metricsButton = document.getElementById('metricsButton');
        const attendeesTableBody = document.getElementById('attendeesTableBody');
        const noAttendeesMessage = document.getElementById('noAttendeesMessage');
        const homeScreenTotalAttendeesCount = document.getElementById('homeScreenTotalAttendeesCount');
        const eventStatusIndicator = document.getElementById('eventStatusIndicator'); 
        const attendeeModal = document.getElementById('attendeeModal');
        const attendeeModalContent = document.getElementById('attendeeModalContent');
        const modalBody = document.getElementById('modalBody');
        const closeAttendeeModalButton = document.getElementById('closeAttendeeModalButton');
        const closeAttendeeModalFooterButton = document.getElementById('closeAttendeeModalFooterButton');
        const demoRequestedButton = document.getElementById('demoRequestedButton');
        const filterModal = document.getElementById('filterModal');
        const closeFilterModalButton = document.getElementById('closeFilterModalButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const metricsModal = document.getElementById('metricsModal');
        const closeMetricsModalButton = document.getElementById('closeMetricsModalButton');
        const closeMetricsModalFooterButton = document.getElementById('closeMetricsModalFooterButton');
        const demoRequestsTableBody = document.getElementById('demoRequestsTableBody');
        const noDemoRequestsMessage = document.getElementById('noDemoRequestsMessage');
        const downloadDemoRequestsCsvButton = document.getElementById('downloadDemoRequestsCsvButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryFetchButton = document.getElementById('retryFetchButton');
        const attendeesTableContainer = document.getElementById('attendeesTableContainer');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmOkButton = document.getElementById('customConfirmOkButton');
        const customConfirmCancelButton = document.getElementById('customConfirmCancelButton');
        const notificationToast = document.getElementById('notificationToast');
        const conversationNoteModal = document.getElementById('conversationNoteModal');
        const closeConversationNoteModalButton = document.getElementById('closeConversationNoteModalButton');
        const conversationNoteInput = document.getElementById('conversationNoteInput');
        const submitConversationNoteButton = document.getElementById('submitConversationNoteButton');
        const cancelConversationNoteButton = document.getElementById('cancelConversationNoteButton');
        const deleteConversationNoteButton = document.getElementById('deleteConversationNoteButton');
        const conversationNoteDisplay = document.getElementById('conversationNoteDisplay');
        const conversationNoteActions = document.getElementById('conversationNoteActions');
        const conversationsTableBody = document.getElementById('conversationsTableBody');
        const noConversationsMessage = document.getElementById('noConversationsMessage');
        const downloadConversationsCsvButton = document.getElementById('downloadConversationsCsvButton');
        
        // --- Global State ---
        let allAttendees = [];
        let currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' }; 
        let currentSearchTerm = '';
        let currentAttendeeForModal = null;
        let currentUserNameFromStorage = '';
        let currentSelectedEventId = null;
        let currentSelectedEventData = null; 
        let pollingTimeoutId = null;
        let sdrChartInstance, aeChartInstance, attendeeTypeChartInstance;
        let confirmCallback = null;

        // Firebase
        let db, auth, currentUserId; 
        let demoStatusUnsubscribe = null; 
        let CURRENT_EVENT_GOOGLE_SHEET_URL = '';


        const firebaseConfig = {
            apiKey: "AIzaSyCRGbSyg71HdQf-zMrjT9Vz9iaCU3cKOPw", 
            authDomain: "attendeetrackerapp.firebaseapp.com", 
            projectId: "attendeetrackerapp", 
            storageBucket: "attendeetrackerapp.appspot.com", 
            messagingSenderId: "301064425215", 
            appId: "1:301064425215:web:17fd2b66cd2e47d9b0c6ca" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendee-app'; 
        setLogLevel('debug'); 

        const headerMapping = {
            'First Name': 'firstName', 'Last Name': 'lastName', 'Email': 'email', 'Phone': 'phone',
            'Company': 'company', 'Job Title': 'jobTitle', 'Type': 'type', 
            'Focus Account': 'focusAccount', 'On-ground AE': 'onGroundAE', 'On-ground SDR': 'onGroundSDR',
            'Notes': 'notes', 'LinkedIn': 'linkedin', 'Recently Migrated logos': 'recentlyMigratedLogos'
        };
        const adminUsers = { "Venkat": "venkata24", "Shitij": "shitija25", "Sandeep": "sandeepa23", "Priya": "priyaa26", "Sravan": "sravana27", "Ashik": "ashika28", "Rohit": "rohita29", "Arti": "artia30"};

        
        // --- Utility & Helper Functions ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            [addEventModal, manageEventsModal, attendeeModal, filterModal, metricsModal, customConfirmModal, conversationNoteModal].forEach(modal => modal.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }
        
        function showCustomConfirm(title, message, callback) {
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            confirmCallback = callback;
            customConfirmModal.classList.remove('hidden');
        }

        function showNotification(message, type = 'info') {
            notificationToast.textContent = message;
            notificationToast.className = 'show';
            if (type === 'success') notificationToast.classList.add('bg-success');
            else if (type === 'error') notificationToast.classList.add('bg-error');
            else notificationToast.classList.add('bg-info');
            setTimeout(() => notificationToast.classList.remove('show'), 3000);
        }
        
        function parseCSV(csvText) {
            const rows = []; let currentRow = []; let currentField = ''; let inQuotes = false;
            csvText = csvText.trim();
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < csvText.length && csvText[i+1] === '"') { currentField += '"'; i++; } else { inQuotes = !inQuotes; }
                } else if (char === ',' && !inQuotes) { currentRow.push(currentField); currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (csvText[i+1] === '\n' && char === '\r') { i++; }
                    currentRow.push(currentField); rows.push(currentRow.map(f => f.trim())); currentRow = []; currentField = '';
                } else { currentField += char; }
            }
            currentRow.push(currentField); 
            if (currentRow.length > 0 && (currentRow.length > 1 || currentRow[0].trim() !== '')) { rows.push(currentRow.map(f => f.trim())); }
            if (rows.length === 0) return [];
            const rawHeaders = rows[0]; const data = []; const actualHeaders = rawHeaders.map(h => String(h).trim());
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i]; const entry = {}; let isEmptyRow = true; const numVals = Math.min(values.length, actualHeaders.length);
                for (let j = 0; j < numVals; j++) {
                    const header = actualHeaders[j]; 
                    const mappedKey = headerMapping[header] || header.toLowerCase().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    entry[mappedKey] = values[j] || ''; 
                    if (values[j] && String(values[j]).trim() !== '') isEmptyRow = false;
                }
                if (!isEmptyRow) { data.push(entry); }
            } return data;
        }

        function populateFilterDropdowns(attendees) {
            const uniqueAEs = new Set(); const uniqueSDRs = new Set();
            attendees.forEach(att => {
                if (att.onGroundAE) uniqueAEs.add(att.onGroundAE.trim());
                if (att.onGroundSDR) uniqueSDRs.add(att.onGroundSDR.trim());
            });
            const filterAE = document.getElementById('filterAE');
            filterAE.innerHTML = '<option value="All">All AEs</option>'; 
            Array.from(uniqueAEs).sort().forEach(ae => { const opt = document.createElement('option'); opt.value = ae; opt.textContent = ae; filterAE.appendChild(opt); });
            const filterSDR = document.getElementById('filterSDR');
            filterSDR.innerHTML = '<option value="All">All SDRs</option>'; 
            Array.from(uniqueSDRs).sort().forEach(sdr => { const opt = document.createElement('option'); opt.value = sdr; opt.textContent = sdr; filterSDR.appendChild(opt); });
        }

        function sanitizeForFirestoreId(id) {
            if (!id) return `unknown_id_${crypto.randomUUID()}`; 
            return id.replace(/[^a-zA-Z0-9_.-]/g, '_');
        }

        function updateEventStatusIndicator() {
            if (!currentSelectedEventData || !currentSelectedEventData.eventDate || !currentSelectedEventData.eventStartTime) return;
            const now = new Date();
            const eventStartDate = new Date(`${currentSelectedEventData.eventDate}T${currentSelectedEventData.eventStartTime}`);
            const eventEndDate = new Date(`${currentSelectedEventData.eventDate}T${currentSelectedEventData.eventEndTime}`);
            if (now < eventStartDate) eventStatusIndicator.style.backgroundColor = 'red';
            else if (now >= eventStartDate && now <= eventEndDate) eventStatusIndicator.style.backgroundColor = '#0abc58';
            else eventStatusIndicator.style.backgroundColor = 'gray';
            eventStatusIndicator.classList.remove('hidden');
        }

        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            attendeesTableContainer.classList.toggle('hidden', isLoading);
            noAttendeesMessage.classList.toggle('hidden', isLoading);
        }

        function showError(show, message = '') {
            errorText.textContent = message; errorMessage.classList.toggle('hidden', !show);
            attendeesTableContainer.classList.toggle('hidden', show); noAttendeesMessage.classList.toggle('hidden', show);
        }

        function copyToClipboard(text, feedbackElement) {
            const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); if(feedbackElement) { feedbackElement.textContent = 'Copied!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            catch (err) { console.error('Copy failed: ', err); if(feedbackElement) { feedbackElement.textContent = 'Copy failed!';}}
            document.body.removeChild(ta);
        }

        function createOrUpdateChart(chartInstance, canvasElement, chartType, data, options) {
            if (chartInstance) { chartInstance.destroy(); }
            return new Chart(canvasElement, { type: chartType, data: data, options: options });
        }
        
        function downloadCSV(data, filename = 'data.csv', headers) {
            let csvRows = [];
            const headerRow = headers.join(',');
            csvRows.push(headerRow);
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const key = Object.keys(row).find(k => k.toLowerCase() === header.toLowerCase().replace(/\s/g, ''));
                    const escaped = ('' + (row[key] || '')).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url); link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        
        async function saveUserName(name) {
             currentUserNameFromStorage = name; 
            localStorage.setItem('attendeeAppUserName', name); 
            if (!db || !currentUserId) {
                console.warn("Firestore not initialized or user ID not available for saving name."); return;
            }
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId);
            try {
                await setDoc(userDocRef, { firstName: name }, { merge: true });
            } catch (error) {
                console.error("Error saving user name to Firestore:", error);
            }
        }
        async function getUserNameFromFirestoreOrLocalStorage() {
            let name = localStorage.getItem('attendeeAppUserName');
            if (name) return name;

            if (!db || !currentUserId) return null;
            
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    name = docSnap.data().firstName;
                    if (name) localStorage.setItem('attendeeAppUserName', name); 
                    return name;
                }
                return null;
            } catch (error) {
                console.error("Error getting user name from Firestore:", error);
                return null;
            }
        }
        async function saveEventProfile(eventData) {
            if (!db) { console.error("Firestore not initialized."); return false; }
            const eventId = eventData.id || sanitizeForFirestoreId(eventData.eventName.toLowerCase().replace(/\s+/g, '-')) + '-' + Date.now(); 
            const eventRef = doc(db, "artifacts", appId, "public", "data", "eventProfiles", eventId);
            try {
                await setDoc(eventRef, { ...eventData, id: eventId, createdAt: new Date().toISOString() });
                return true;
            } catch (error) {
                console.error("Error saving event profile:", error);
                return false;
            }
        }
        async function fetchEventProfiles() {
            if (!db) { console.error("Firestore not initialized."); return []; }
            const eventsCol = collection(db, "artifacts", appId, "public", "data", "eventProfiles");
            try {
                const snapshot = await getDocs(eventsCol);
                const events = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                return events.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 
            } catch (error) {
                console.error("Error fetching event profiles:", error);
                return [];
            }
        }
        async function deleteEventProfile(eventId) {
            if (!db) { console.error("Firestore not initialized."); return; }
            
            showCustomConfirm("Delete Event", `Are you sure you want to delete this event and all its associated data (like demo requests)? This action cannot be undone.`, async (confirmed) => {
                if (!confirmed) return;
                
                const deleteEventButton = document.getElementById('deleteEventButton');
                deleteEventButton.disabled = true; deleteEventButton.textContent = 'Deleting...';
                try {
                    const batch = writeBatch(db);
                    const eventRef = doc(db, "artifacts", appId, "public", "data", "eventProfiles", eventId);
                    batch.delete(eventRef);

                    const demoRequestsCol = collection(db, "artifacts", appId, "public", "data", "demoRequests", eventId, "attendees");
                    const demoRequestsSnapshot = await getDocs(demoRequestsCol);
                    demoRequestsSnapshot.forEach(docSnap => batch.delete(docSnap.ref));
                    
                    const conversationNotesCol = collection(db, "artifacts", appId, "public", "data", "conversationNotes", eventId, "attendees");
                    const conversationNotesSnapshot = await getDocs(conversationNotesCol);
                    conversationNotesSnapshot.forEach(docSnap => batch.delete(docSnap.ref));

                    await batch.commit();
                    await Promise.all([populateManageEventsDropdown(), populateEventTiles()]);
                    showNotification("Event deleted successfully.", "success"); 
                } catch (error) {
                    console.error("Error deleting event profile:", error);
                    showNotification("Failed to delete event.", "error"); 
                } finally {
                    deleteEventButton.disabled = false; deleteEventButton.textContent = 'Delete Selected Event';
                }
            });
        }
        async function populateManageEventsDropdown() {
             const events = await fetchEventProfiles();
             const manageEventDropdown = document.getElementById('manageEventDropdown');
            manageEventDropdown.innerHTML = '<option value="">-- Select Event --</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.eventName;
                manageEventDropdown.appendChild(option);
            });
        }
        async function populateEventTiles() {
             const events = await fetchEventProfiles();
             const eventTilesContainer = document.getElementById('eventTilesContainer');
             const noEventsToShowMessage = document.getElementById('noEventsToShowMessage');
            eventTilesContainer.innerHTML = ''; 
            if (events.length === 0) {
                noEventsToShowMessage.classList.remove('hidden');
                return;
            }
            noEventsToShowMessage.classList.add('hidden');

            events.forEach(event => {
                const tile = document.createElement('div');
                tile.className = 'grid-tile';
                tile.dataset.eventId = event.id;
                const img = document.createElement('img');
                img.src = event.eventBannerUrl || 'https://placehold.co/300x100/cccccc/333333?text=No+Banner';
                img.alt = event.eventName;
                img.onerror = function() { this.src='https://placehold.co/300x100/cccccc/333333?text=Banner+Error'; };
                const name = document.createElement('h3');
                name.className = 'text-lg font-semibold text-gray-800 mt-2';
                name.textContent = event.eventName;
                const dateText = event.eventDate ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'Date TBD';
                const date = document.createElement('p');
                date.className = 'text-xs text-gray-500';
                date.textContent = dateText;
                tile.appendChild(img);
                tile.appendChild(name);
                tile.appendChild(date);
                tile.addEventListener('click', () => loadEventSpecificView(event));
                eventTilesContainer.appendChild(tile);
            });
        }
        
        // --- Core App Logic & Data Handling ---
        function applyFiltersAndSearch() {
            let filtered = [...allAttendees];
            
            filtered = filtered.filter(att => 
                (currentFilters.type === 'All' || (att.type && att.type.toLowerCase() === currentFilters.type.toLowerCase())) &&
                (currentFilters.focusAccount === 'All' || (att.focusAccount && att.focusAccount.toLowerCase() === currentFilters.focusAccount.toLowerCase())) &&
                (currentFilters.onGroundAE === 'All' || (att.onGroundAE && att.onGroundAE === currentFilters.onGroundAE)) && 
                (currentFilters.onGroundSDR === 'All' || (att.onGroundSDR && att.onGroundSDR === currentFilters.onGroundSDR))
            );

            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(att =>
                    (`${att.firstName || ''} ${att.lastName || ''}`.toLowerCase().includes(searchTermLower)) ||
                    ((att.company || '').toLowerCase().includes(searchTermLower)) ||
                    ((att.jobTitle || '').toLowerCase().includes(searchTermLower))
                );
            }
            
            filtered.sort((a, b) => (`${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase()).localeCompare(`${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase()));
            
            if (!loadingSpinner.classList.contains('hidden') || !errorMessage.classList.contains('hidden')) {} 
            else {
                attendeesTableContainer.classList.remove('hidden'); 
                renderTable(filtered);
            }
            homeScreenTotalAttendeesCount.textContent = allAttendees.length;
        }

        async function fetchAttendees(proxyIndex = 0) {
            if (!currentSelectedEventData || !currentSelectedEventData.eventSheetUrl) {
                showError(true, "No event selected or data source missing.");
                return;
            }
            // Only show loading spinner on the first attempt
            if (proxyIndex === 0) {
                showLoading(true);
                showError(false);
            }
            try {
                let sheetUrl = currentSelectedEventData.eventSheetUrl;
                const urlWithCacheBuster = `${sheetUrl}&t=${new Date().getTime()}`;
                let urlToFetch = urlWithCacheBuster;

                if (sheetUrl.startsWith("https://docs.google.com/spreadsheets/")) {
                    const proxy = CORS_PROXIES[proxyIndex];
                    console.log(`Using proxy: ${proxy}`);
                    if (proxy.includes('?url=')) {
                        urlToFetch = `${proxy}${encodeURIComponent(urlWithCacheBuster)}`;
                    } else {
                        urlToFetch = `${proxy}${urlWithCacheBuster}`;
                    }
                }
                const response = await fetch(urlToFetch);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const csvText = await response.text();
                let parsedAtt = (csvText.trim() === '') ? [] : parseCSV(csvText);
                allAttendees = parsedAtt.map(att => ({ ...att, demoRequested: false, demoRequestedBy: '' })).filter(att => (att.firstName || att.lastName || att.company || att.jobTitle));
                
                populateFilterDropdowns(allAttendees);
                listenForDemoStatusChanges();
                showLoading(false); // Success, so hide spinner
            } catch (error) {
                console.error(`Fetch failed with proxy ${CORS_PROXIES[proxyIndex]}:`, error);
                const nextProxyIndex = proxyIndex + 1;
                if (nextProxyIndex < CORS_PROXIES.length) {
                    console.log(`Trying next proxy... (${CORS_PROXIES[nextProxyIndex]})`);
                    setTimeout(() => fetchAttendees(nextProxyIndex), 250); // Try next proxy after a short delay
                } else {
                    showError(true, `Failed to load attendee data after trying all options. Please check network and source URL.`);
                    showLoading(false);
                }
            }
        }


        function listenForDemoStatusChanges() {
            if (demoStatusUnsubscribe) demoStatusUnsubscribe();
            if (!db || !currentSelectedEventId) return;

            const demoStatusCol = collection(db, "artifacts", appId, "public", "data", "demoRequests", currentSelectedEventId, "attendees");
            demoStatusUnsubscribe = onSnapshot(demoStatusCol, (snapshot) => {
                const demoUpdates = new Map(snapshot.docs.map(doc => [doc.id, doc.data()]));
                allAttendees.forEach(attendee => {
                    const safeEmailId = sanitizeForFirestoreId(attendee.email);
                    const update = demoUpdates.get(safeEmailId);
                    attendee.demoRequested = update?.requested || false;
                    attendee.demoRequestedBy = update?.requestedBy || '';
                });
                if (currentAttendeeForModal && !attendeeModal.classList.contains('hidden')) {
                     const updatedAttendee = allAttendees.find(a => a.email === currentAttendeeForModal.email);
                     if (updatedAttendee) {
                         currentAttendeeForModal = updatedAttendee;
                         updateDemoRequestedButtonUI(updatedAttendee.demoRequested);
                     }
                }
                applyFiltersAndSearch();
            }, (error) => console.error("Error listening to demo status:", error));
        }

        function renderTable(attendeesToRender) {
            attendeesTableBody.innerHTML = ''; 
            const tableHeader = attendeesTableContainer.querySelector('table thead');
            if (attendeesToRender.length === 0) {
                noAttendeesMessage.classList.remove('hidden'); tableHeader.classList.add('hidden');
            } else {
                noAttendeesMessage.classList.add('hidden'); tableHeader.classList.remove('hidden'); 
                attendeesToRender.forEach(attendee => {
                    const row = attendeesTableBody.insertRow();
                    row.className = 'hover:bg-gray-100 cursor-pointer transition-colors no-select';
                    if (attendee.demoRequested) row.classList.add('demo-requested-row-active');
                    const [cellName, cellCompany, cellTitle] = [row.insertCell(), row.insertCell(), row.insertCell()];
                    cellName.textContent = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim() || 'N/A';
                    cellCompany.textContent = attendee.company || 'N/A';
                    cellTitle.textContent = attendee.jobTitle || 'N/A';
                    [cellName, cellCompany, cellTitle].forEach(cell => cell.className = 'px-6 py-4 text-sm text-gray-700 break-words');
                    row.addEventListener('click', () => openAttendeeDetailModal(attendee));
                });
            }
        }
        
        async function openAttendeeDetailModal(attendee) {
            currentAttendeeForModal = attendee; 
            modalBody.innerHTML = ''; 
            
            const createDetailRow = (label, value, type = 'text', isLink = false) => {
                if (!value || String(value).trim() === '') return;
                const div = document.createElement('div');
                div.className = 'grid grid-cols-3 gap-2 items-start';
                div.innerHTML = `<p class="text-sm font-medium text-gray-500 col-span-1 break-words">${label}:</p>`;
                const valCont = document.createElement('div');
                valCont.className = 'text-sm text-gray-900 col-span-2 break-words flex items-center';
                if (isLink) {
                    let hrefValue = String(value).match(/^https?:\/\//i) ? value : 'https://' + value;
                    valCont.innerHTML = `<a href="${hrefValue}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${value}</a>`;
                } else if (type === 'email') {
                     valCont.innerHTML = `<span class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer">${value}</span><span class="copy-feedback"></span>`;
                     valCont.querySelector('span').addEventListener('click', () => copyToClipboard(value, valCont.querySelector('.copy-feedback')));
                } else {
                    valCont.innerHTML = String(value).replace(/\n/g, '<br>');
                }
                div.appendChild(valCont);
                modalBody.appendChild(div);
            };

            createDetailRow('Full Name', `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim());
            createDetailRow('Company', attendee.company); 
            createDetailRow('Job Title', attendee.jobTitle); 
            createDetailRow('Email', attendee.email, 'email'); 

            if (currentSelectedEventData.eventName === "Customer Engagement Summit 2025") {
                const displayedKeys = new Set(['firstName', 'lastName', 'company', 'jobTitle', 'email', 'demoRequested', 'demoRequestedBy', 'name']);
                for (const key in attendee) {
                    if (attendee.hasOwnProperty(key) && !displayedKeys.has(key)) {
                        const value = attendee[key];
                        if (value && String(value).trim() !== '') {
                            let label = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, (str) => str.toUpperCase());
                            if (label.toLowerCase() === 'account intel') label = 'Account Intel';
                            createDetailRow(label, value, 'text', key.toLowerCase().includes('linkedin'));
                        }
                    }
                }
            } else {
                createDetailRow('Type', attendee.type); createDetailRow('Focus Account', attendee.focusAccount); 
                createDetailRow('On-ground AE', attendee.onGroundAE); createDetailRow('On-ground SDR', attendee.onGroundSDR);
                createDetailRow('LinkedIn', attendee.linkedin, 'text', true); createDetailRow('Recently Migrated logos', attendee.recentlyMigratedLogos);
                createDetailRow('Public Notes', attendee.notes);
            }
            
            await setupConversationSection(attendee);
            updateDemoRequestedButtonUI(attendee.demoRequested === true);
            attendeeModal.classList.remove('hidden');
        }
        function closeAttendeeDetailModal() { 
            attendeeModal.classList.add('hidden');
            currentAttendeeForModal = null; 
            attendeeModalContent.classList.remove('demo-requested-active');
        }

        async function toggleDemoRequest(attendee) {
            if (!db || !currentUserId || !attendee?.email || !currentSelectedEventId) {
                 showNotification("Could not update demo request. Critical info missing.", "error"); return;
            }
            const safeEmailId = sanitizeForFirestoreId(attendee.email);
            const demoStatusRef = doc(db, "artifacts", appId, "public", "data", "demoRequests", currentSelectedEventId, "attendees", safeEmailId); 
            const newDemoStatus = !attendee.demoRequested; 
            try {
                if (newDemoStatus) {
                    await setDoc(demoStatusRef, { requested: true, requestedBy: currentUserNameFromStorage || "Unknown", timestamp: new Date().toISOString() });
                } else {
                    await deleteDoc(demoStatusRef); 
                }
            } catch (error) {
                console.error("Error updating demo request status:", error);
                showNotification(`Failed to update demo request: ${error.message}.`, "error");
            }
        }
        
        function updateDemoRequestedButtonUI(isRequested) {
            const [btnText, btnCheck] = [document.getElementById('demoRequestedButtonText'), document.getElementById('demoRequestedCheckmark')];
            btnText.textContent = isRequested ? 'Requested' : 'Demo Requested';
            btnCheck.classList.toggle('hidden', !isRequested);
            demoRequestedButton.classList.toggle('bg-gray-300', isRequested);
            demoRequestedButton.classList.toggle('hover:bg-gray-300', isRequested);
            demoRequestedButton.classList.toggle('text-gray-500', isRequested);
            demoRequestedButton.classList.toggle('bg-orange-500', !isRequested);
            demoRequestedButton.classList.toggle('hover:bg-orange-600', !isRequested);
            attendeeModalContent.classList.toggle('demo-requested-active', isRequested);
        }

        // --- Conversation Notes Logic ---
        async function setupConversationSection(attendee) {
            conversationNoteDisplay.textContent = 'Loading note...';
            conversationNoteActions.innerHTML = '';
            if (!db || !currentUserId || !attendee?.email || !currentSelectedEventId) {
                conversationNoteDisplay.textContent = 'Could not load notes.'; return;
            }
            const noteRef = doc(db, "artifacts", appId, "public", "data", "conversationNotes", currentSelectedEventId, "attendees", sanitizeForFirestoreId(attendee.email));
            try {
                const docSnap = await getDoc(noteRef);
                const noteData = docSnap.exists() ? docSnap.data() : null;
                renderConversationNote(noteData);
            } catch (error) {
                console.error("Error fetching note:", error);
                conversationNoteDisplay.textContent = 'Error loading note.';
            }
        }

        function renderConversationNote(noteData) {
            const note = noteData ? noteData.note : null;
            const updatedBy = noteData ? noteData.lastUpdatedBy : null;

            if (note) {
                conversationNoteDisplay.textContent = note;
                if(updatedBy){
                    const updatedByEl = document.createElement('div');
                    updatedByEl.className = 'text-xs text-gray-500 italic mt-1';
                    updatedByEl.textContent = `(Last updated by: ${updatedBy})`;
                    conversationNoteDisplay.appendChild(updatedByEl);
                }
                conversationNoteActions.innerHTML = `<button id="editConversationNoteBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Edit</button>`;
                document.getElementById('editConversationNoteBtn').addEventListener('click', () => openConversationNoteModal(note));
            } else {
                conversationNoteDisplay.textContent = 'No conversation recorded yet.';
                conversationNoteActions.innerHTML = `<button id="addConversationNoteBtn" class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-lg">Add</button>`;
                document.getElementById('addConversationNoteBtn').addEventListener('click', () => openConversationNoteModal());
            }
        }
        
        function openConversationNoteModal(existingNote = '') {
            conversationNoteInput.value = existingNote;
            deleteConversationNoteButton.classList.toggle('hidden', !existingNote);
            conversationNoteModal.classList.remove('hidden');
        }

        async function handleSaveNote() {
            if (!currentAttendeeForModal?.email) return;
            const noteText = conversationNoteInput.value.trim();
            const noteRef = doc(db, "artifacts", appId, "public", "data", "conversationNotes", currentSelectedEventId, "attendees", sanitizeForFirestoreId(currentAttendeeForModal.email));
            try {
                const noteData = { 
                    note: noteText, 
                    lastUpdated: new Date().toISOString(),
                    lastUpdatedBy: currentUserNameFromStorage || "Unknown User"
                };
                await setDoc(noteRef, noteData);
                showNotification("Note saved successfully.", "success");
                conversationNoteModal.classList.add('hidden');
                renderConversationNote(noteData);
            } catch (error) {
                showNotification("Failed to save note.", "error");
                console.error("Error saving note:", error);
            }
        }
        
        async function handleDeleteNote() {
            if (!currentAttendeeForModal?.email) return;
            showCustomConfirm("Delete Note", "Are you sure you want to delete this public note? This action cannot be undone.", async (confirmed) => {
                if (!confirmed) return;
                const noteRef = doc(db, "artifacts", appId, "public", "data", "conversationNotes", currentSelectedEventId, "attendees", sanitizeForFirestoreId(currentAttendeeForModal.email));
                try {
                    await deleteDoc(noteRef);
                    showNotification("Note deleted.", "success");
                    conversationNoteModal.classList.add('hidden');
                    renderConversationNote(null);
                } catch (error) {
                    showNotification("Failed to delete note.", "error");
                    console.error("Error deleting note:", error);
                }
            });
        }
        
        function loadEventSpecificView(eventData) {
            if (demoStatusUnsubscribe) demoStatusUnsubscribe();
            if (pollingTimeoutId) clearInterval(pollingTimeoutId);

            currentSelectedEventId = eventData.id;
            currentSelectedEventData = eventData;
            
            allAttendees = []; 
            currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
            currentSearchTerm = '';
            searchInput.value = '';
            attendeesTableBody.innerHTML = '';
            
            document.getElementById('eventSpecificBanner').src = eventData.eventBannerUrl || 'https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';
            document.getElementById('eventSpecificTitle').textContent = eventData.eventName;
            
            showScreen('mainApp');
            fetchAttendees();
            pollingTimeoutId = setInterval(fetchAttendees, POLLING_INTERVAL);
        }
        
        // --- Initialization and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();

             enterAppButton.addEventListener('click', async () => {
                const name = userNameInput.value.trim();
                if (name) {
                    await saveUserName(name);
                    document.getElementById('welcomeBackMessage').textContent = `Welcome back, ${name}!`;
                    document.getElementById('userNamePrompt').classList.add('hidden');
                    document.getElementById('returningUserOptions').classList.remove('hidden');
                } else {
                    showNotification("Please enter your first name.", "error");
                }
            });

            document.getElementById('viewEventsButton').addEventListener('click', () => showScreen('eventSelection'));
            document.getElementById('adminControlsLoginButton').addEventListener('click', () => showScreen('adminLogin'));
            document.getElementById('backToWelcomeFromAdminLoginButton').addEventListener('click', () => showScreen('welcome'));
            document.getElementById('adminLogoutButton').addEventListener('click', () => { sessionStorage.removeItem('adminLoggedIn'); showScreen('welcome'); });
            document.getElementById('addEventTile').addEventListener('click', () => { document.getElementById('addEventForm').reset(); addEventModal.classList.remove('hidden'); });
            document.getElementById('closeAddEventModalButton').addEventListener('click', () => addEventModal.classList.add('hidden'));
            document.getElementById('manageEventsTile').addEventListener('click', async () => { await populateManageEventsDropdown(); manageEventsModal.classList.remove('hidden'); });
            document.getElementById('closeManageEventsModalButton').addEventListener('click', () => manageEventsModal.classList.add('hidden'));
            document.getElementById('doneManageEventsButton').addEventListener('click', () => manageEventsModal.classList.add('hidden'));
            document.getElementById('backToEventSelectionButton').addEventListener('click', () => {
                if (pollingTimeoutId) clearInterval(pollingTimeoutId);
                if(demoStatusUnsubscribe) demoStatusUnsubscribe();
                showScreen('eventSelection');
            });

            applyFiltersButton.addEventListener('click', () => {
                currentFilters.type = document.getElementById('filterType').value;
                currentFilters.focusAccount = document.getElementById('filterFocusAccount').value;
                currentFilters.onGroundAE = document.getElementById('filterAE').value;
                currentFilters.onGroundSDR = document.getElementById('filterSDR').value;
                applyFiltersAndSearch(); filterModal.classList.add('hidden');
            });
            clearFiltersButton.addEventListener('click', () => {
                ['filterType', 'filterFocusAccount', 'filterAE', 'filterSDR'].forEach(id => document.getElementById(id).value = 'All');
                currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
                applyFiltersAndSearch(); filterModal.classList.add('hidden');
            });
            
            searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFiltersAndSearch(); });
            filterButton.addEventListener('click', () => filterModal.classList.remove('hidden'));
            metricsButton.addEventListener('click', openMetricsModal);
            closeFilterModalButton.addEventListener('click', () => filterModal.classList.add('hidden'));
            closeMetricsModalButton.addEventListener('click', () => metricsModal.classList.add('hidden'));
            closeMetricsModalFooterButton.addEventListener('click', () => metricsModal.classList.add('hidden'));
            demoRequestedButton.addEventListener('click', () => { if (currentAttendeeForModal) toggleDemoRequest(currentAttendeeForModal); });
            closeAttendeeModalButton.addEventListener('click', closeAttendeeDetailModal);
            closeAttendeeModalFooterButton.addEventListener('click', closeAttendeeDetailModal);

            // Conversation Note Modal Listeners
            closeConversationNoteModalButton.addEventListener('click', () => conversationNoteModal.classList.add('hidden'));
            cancelConversationNoteButton.addEventListener('click', () => conversationNoteModal.classList.add('hidden'));
            submitConversationNoteButton.addEventListener('click', handleSaveNote);
            deleteConversationNoteButton.addEventListener('click', handleDeleteNote);

            downloadConversationsCsvButton.addEventListener('click', async () => {
                const notes = await fetchAllNotesForEvent();
                if(notes.length > 0) {
                     downloadCSV(notes, 'public-conversations.csv', ['Name', 'Company', 'Email', 'Note', 'Last Updated By']);
                } else {
                    showNotification("No conversations to download.", "info");
                }
            });

            downloadDemoRequestsCsvButton.addEventListener('click', async () => {
                const requests = await fetchAllDemoRequestsForEvent();
                if(requests.length > 0) {
                     downloadCSV(requests, 'demo-requests.csv', ['Name', 'Company', 'Job Title', 'Requested By']);
                } else {
                    showNotification("No demo requests to download.", "info");
                }
            });
        });
        
        async function initializeAppLogic() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                   try { await signInWithCustomToken(auth, __initial_auth_token); } 
                   catch (e) { console.warn("Custom token failed, falling back to anonymous.", e.message); await signInAnonymously(auth); }
                } else { await signInAnonymously(auth); }
                currentUserId = auth.currentUser?.uid || `local-${crypto.randomUUID()}`;
                currentUserNameFromStorage = await getUserNameFromFirestoreOrLocalStorage(); 
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to essential services.", "error");
                db = null; auth = null; currentUserId = `local-${crypto.randomUUID()}`; 
            }

            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showScreen('adminControls');
            } else if (currentUserNameFromStorage) {
                document.getElementById('welcomeBackMessage').textContent = `Welcome back, ${currentUserNameFromStorage}!`;
                document.getElementById('userNamePrompt').classList.add('hidden');
                document.getElementById('returningUserOptions').classList.remove('hidden');
            } else {
                document.getElementById('userNamePrompt').classList.remove('hidden');
                document.getElementById('returningUserOptions').classList.add('hidden');
            }
            showScreen('welcome');
            
            const adminUsernameSelect = document.getElementById('adminUsername');
            adminUsernameSelect.innerHTML = ''; 
            Object.keys(adminUsers).forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                adminUsernameSelect.appendChild(option);
            });
            
            if (db) { 
                const initialEvents = [
                    { eventName: "#GROWTH Summit Mumbai 2025", city: "Mumbai", eventDate: "2025-05-28", eventStartTime: "09:30", eventEndTime: "22:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv", eventBannerUrl: "https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" },
                    { eventName: "#GROWTH Summit Dubai 2025", city: "Dubai", eventDate: "2025-11-12", eventStartTime: "16:00", eventEndTime: "22:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv", eventBannerUrl: "https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" },
                    { eventName: "Customer Engagement Summit 2025", city: "New York", eventDate: "2025-09-24", eventStartTime: "09:00", eventEndTime: "19:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCr4DyPsk-XWPtgbSj9Ren9mZ0MU91KSJ-PES8JeFc2EYMo272N3Yv14NGvCWEWcaGfATcqPXWGz9g/pub?gid=943729267&single=true&output=csv", eventBannerUrl: "https://info.moengage.com/hubfs/CES_logo_vertical.png" }
                ];

                for (const event of initialEvents) {
                    const eventId = sanitizeForFirestoreId(event.eventName.toLowerCase().replace(/\s+/g, '-')) + '-' + new Date(event.eventDate).getTime(); 
                    const eventRef = doc(db, "artifacts", appId, "public", "data", "eventProfiles", eventId);
                    try {
                        const docSnap = await getDoc(eventRef);
                        if (!docSnap.exists()) await setDoc(eventRef, { ...event, id: eventId, createdAt: new Date().toISOString() }); 
                    } catch(e) { console.error("Error checking/saving initial event:", e); }
                }
            }
            await populateEventTiles();
        }
        
        async function fetchAllNotesForEvent() {
            if (!db || !currentSelectedEventId) return [];
            const notesCol = collection(db, "artifacts", appId, "public", "data", "conversationNotes", currentSelectedEventId, "attendees");
            try {
                const snapshot = await getDocs(notesCol);
                const notesData = snapshot.docs.map(d => ({ 
                    emailId: d.id, 
                    ...d.data()
                }));

                return notesData.map(noteInfo => {
                    const attendee = allAttendees.find(att => sanitizeForFirestoreId(att.email) === noteInfo.emailId);
                    return {
                        name: attendee ? `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim() : 'Unknown',
                        company: attendee ? attendee.company : 'Unknown',
                        email: attendee ? attendee.email : noteInfo.emailId.replace(/_/g,'.'),
                        note: noteInfo.note,
                        lastupdatedby: noteInfo.lastUpdatedBy
                    };
                });
            } catch (error) {
                console.error("Error fetching all notes for metrics:", error);
                return [];
            }
        }

        async function fetchAllDemoRequestsForEvent() {
            if (!db || !currentSelectedEventId) return [];
            const requestsCol = collection(db, "artifacts", appId, "public", "data", "demoRequests", currentSelectedEventId, "attendees");
            try {
                const snapshot = await getDocs(requestsCol);
                const requestsData = snapshot.docs.map(d => ({ emailId: d.id, ...d.data() }));
                
                return requestsData.map(reqInfo => {
                    const attendee = allAttendees.find(att => sanitizeForFirestoreId(att.email) === reqInfo.emailId);
                    return {
                        name: attendee ? `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim() : 'Unknown',
                        company: attendee ? attendee.company : 'Unknown',
                        jobtitle: attendee ? attendee.jobTitle : 'Unknown',
                        requestedby: reqInfo.requestedBy,
                    };
                });
            } catch (error) {
                console.error("Error fetching all demo requests for metrics:", error);
                return [];
            }
        }

        async function openMetricsModal() {
            const sdrChartCanvas = document.getElementById('sdrChart');
            const aeChartCanvas = document.getElementById('aeChart');
            const attendeeTypeChartCanvas = document.getElementById('attendeeTypeChart');
            
            document.getElementById('totalAttendeesCount').textContent = allAttendees.length; 
            const sdrCounts = {}; const aeCounts = {}; const typeCounts = { 'Prospect': 0, 'Partner': 0, 'Customer': 0 };

            allAttendees.forEach(att => {
                if (att.onGroundSDR) sdrCounts[att.onGroundSDR.split(' ')[0]] = (sdrCounts[att.onGroundSDR.split(' ')[0]] || 0) + 1;
                if (att.onGroundAE) aeCounts[att.onGroundAE.split(' ')[0]] = (aeCounts[att.onGroundAE.split(' ')[0]] || 0) + 1;
                if (att.type && typeCounts.hasOwnProperty(att.type)) typeCounts[att.type]++;
            });
            const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, beginAtZero: true }, x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }}}, plugins: { legend: { display: false }}, animation: false };
            sdrChartInstance = createOrUpdateChart(sdrChartInstance, sdrChartCanvas, 'bar', { labels: Object.keys(sdrCounts), datasets: [{ data: Object.values(sdrCounts), backgroundColor: '#0abd57' }] }, chartOptions);
            aeChartInstance = createOrUpdateChart(aeChartInstance, aeChartCanvas, 'bar', { labels: Object.keys(aeCounts), datasets: [{ data: Object.values(aeCounts), backgroundColor: '#17494c' }] }, chartOptions);
            attendeeTypeChartInstance = createOrUpdateChart(attendeeTypeChartInstance, attendeeTypeChartCanvas, 'bar', { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#0abd57', '#17494c', '#000000'] }] }, chartOptions);

            // Populate Demo Requests Table
            const demoRequestedAttendees = await fetchAllDemoRequestsForEvent();
            demoRequestsTableBody.innerHTML = '';
            if (demoRequestedAttendees.length > 0) {
                noDemoRequestsMessage.classList.add('hidden');
                demoRequestsTableBody.parentElement.classList.remove('hidden');
                demoRequestedAttendees.forEach(att => {
                    const row = demoRequestsTableBody.insertRow();
                    row.innerHTML = `<td class="px-6 py-3 text-sm">${att.name}</td><td class="px-6 py-3 text-sm">${att.company || 'N/A'}</td><td class="px-6 py-3 text-sm">${att.jobtitle || 'N/A'}</td><td class="px-6 py-3 text-sm">${att.requestedby || 'N/A'}</td>`;
                });
            } else {
                noDemoRequestsMessage.classList.remove('hidden');
                demoRequestsTableBody.parentElement.classList.add('hidden');
            }

            // Populate Conversations Table
            const myNotes = await fetchAllNotesForEvent();
            conversationsTableBody.innerHTML = '';
            if (myNotes.length > 0) {
                noConversationsMessage.classList.add('hidden');
                conversationsTableBody.parentElement.parentElement.classList.remove('hidden');
                myNotes.forEach(note => {
                    const row = conversationsTableBody.insertRow();
                    row.innerHTML = `<td class="px-6 py-3 text-sm">${note.name}</td><td class="px-6 py-3 text-sm">${note.company}</td><td class="px-6 py-3 text-sm">${note.email}</td><td class="px-6 py-3 text-sm whitespace-pre-wrap">${note.note}</td><td class="px-6 py-3 text-sm">${note.lastupdatedby || 'N/A'}</td>`;
                });
            } else {
                noConversationsMessage.classList.remove('hidden');
                conversationsTableBody.parentElement.parentElement.classList.add('hidden');
            }

            metricsModal.classList.remove('hidden');
        }

    </script>
</body>
</html>

