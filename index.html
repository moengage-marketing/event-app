<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Attendee Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Basic styling for modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Ensure table headers are sticky if table scrolls */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* Tailwind gray-50 */
            z-index: 10;
        }
        /* Prevent text selection on click for better UX on interactive elements */
        .no-select {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Edge, Opera and Firefox */
        }
        /* Ensure images don't overflow their containers */
        img {
            max-width: 100%;
            height: auto;
        }
        .copy-feedback {
            font-size: 0.75rem; /* text-xs */
            color: #10B981; /* green-600 */
            margin-left: 8px; /* ml-2 */
            display: inline-block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px; /* Adjust as needed */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 350px; /* Max height */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .chart-container {
                height: 350px;
            }
        }
        .side-by-side-charts .chart-container {
             max-width: 100%; /* Allow them to fill their flex item */
        }
        .demo-requested-active {
            background-color: #cffde3 !important; 
        }
        .demo-requested-row-active {
            background-color: #cffde3; 
        }
        .demo-requested-row-active:hover {
            background-color: #b6f7d0 !important; /* Slightly darker green on hover */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="welcomeScreen" class="fixed inset-0 bg-gray-100 z-[100] flex flex-col items-center justify-center p-8">
        <p class="text-3xl md:text-4xl font-bold text-gray-700 mb-4">Welcome to</p>
        <img src="https://info.moengage.com/hubfs/Growth%20Summit%20logo.png" 
             alt="Event Banner" 
             class="max-w-xs md:max-w-md h-auto mx-auto rounded-lg mb-8" 
             onerror="this.onerror=null; this.src='https://placehold.co/400x150/cccccc/333333?text=Event+Banner';">
        <div class="w-full max-w-sm">
            <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-1">Please enter your first name:</label>
            <input type="text" id="userNameInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Your First Name">
            <button id="enterAppButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">Enter</button>
        </div>
    </div>

    <div id="mainAppContent" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-6 text-center">
            <img src="https://info.moengage.com/hubfs/Growth%20Summit%20logo.png" 
                 alt="Event Banner" 
                 class="max-w-full h-auto mx-auto rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';">
        </header>

        <main class="bg-white p-6 rounded-lg shadow-xl">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700 mb-2 text-center">Checked-in Attendees</h1>
            <div id="homeScreenTotalAttendeesBox" class="text-center mb-6 p-4 rounded-lg w-full md:w-3/5 mx-auto" style="background-color: #16484d;">
                <span id="homeScreenTotalAttendeesCount" class="text-2xl font-bold text-white">0</span>
                <span class="text-xl text-white"> Attendees</span>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 md:space-x-4">
                <button id="filterButton"
                        style="background-color: #0abc58;" class="w-full md:w-auto order-1 md:order-none hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" />
                    </svg>
                    Filters
                </button>
                <div class="relative w-full md:flex-grow order-none md:order-none">
                    <input type="text" id="searchInput"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                           placeholder="Search by name, company, or job title...">
                    <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <button id="metricsButton"
                        style="background-color: #16484d;" 
                        class="w-full md:w-auto order-2 md:order-none hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Metrics
                </button>
            </div>

            <div id="loadingSpinner" class="text-center py-10 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                <p class="text-gray-600 mt-2">Loading attendees...</p>
            </div>
            
            <div id="errorMessage" class="text-center py-10 hidden bg-red-100 text-red-700 p-4 rounded-lg">
                <p id="errorText"></p>
                <button id="retryFetchButton" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Retry
                </button>
            </div>

            <div id="attendeesTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm table-fixed">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="w-[20%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
                <p id="noAttendeesMessage" class="text-center text-gray-500 py-10 hidden">No attendees checked in yet.</p>
            </div>
        </main>

        <div id="attendeeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="attendeeModalContent" class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Details</h3>
                    <button id="closeAttendeeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalBody" class="p-6 space-y-3"></div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                     <button id="demoRequestedButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <span id="demoRequestedButtonText">Demo Requested</span>
                        <span id="demoRequestedCheckmark" class="ml-2 hidden">âœ“</span>
                    </button>
                     <button id="closeAttendeeModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="filterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Filter Attendees</h3>
                    <button id="closeFilterModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="filterType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Prospect">Prospect</option> <option value="Partner">Partner</option> <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterFocusAccount" class="block text-sm font-medium text-gray-700 mb-1">Focus Account</label>
                        <select id="filterFocusAccount" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Yes">Yes</option> <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAE" class="block text-sm font-medium text-gray-700 mb-1">On-ground AE</label>
                        <select id="filterAE" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All AEs</option></select>
                    </div>
                    <div>
                        <label for="filterSDR" class="block text-sm font-medium text-gray-700 mb-1">On-ground SDR</label>
                         <select id="filterSDR" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All SDRs</option></select>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="clearFiltersButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">Clear Filters</button>
                    <button id="applyFiltersButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Apply Filters</button>
                </div>
            </div>
        </div>
        
        <div id="metricsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Metrics</h3>
                    <button id="closeMetricsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700">Total Checked-in: <span id="totalAttendeesCount" class="text-blue-600">0</span></h4>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts">
                        <div class="md:w-1/2 chart-container">
                             <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by SDR</h4>
                            <canvas id="sdrChart"></canvas>
                        </div>
                        <div class="md:w-1/2 chart-container">
                            <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by AE</h4>
                            <canvas id="aeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by Type</h4>
                        <canvas id="attendeeTypeChart"></canvas>
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Attendees Requesting Demo</h4>
                        <div id="demoRequestsTableContainer" class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                    </tr>
                                </thead>
                                <tbody id="demoRequestsTableBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                            <p id="noDemoRequestsMessage" class="text-center text-gray-500 py-6 hidden">No demo requests yet.</p>
                        </div>
                        <div class="mt-4 text-center">
                             <button id="downloadDemoRequestsCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Download Demo Requests CSV</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
                     <button id="closeMetricsModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv';
        const POLLING_INTERVAL = 30000; 

        const welcomeScreen = document.getElementById('welcomeScreen');
        const mainAppContent = document.getElementById('mainAppContent');
        const userNameInput = document.getElementById('userNameInput');
        const enterAppButton = document.getElementById('enterAppButton');

        const searchInput = document.getElementById('searchInput');
        const filterButton = document.getElementById('filterButton');
        const metricsButton = document.getElementById('metricsButton');
        const attendeesTableBody = document.getElementById('attendeesTableBody');
        const noAttendeesMessage = document.getElementById('noAttendeesMessage');
        const homeScreenTotalAttendeesCount = document.getElementById('homeScreenTotalAttendeesCount');
        
        const attendeeModal = document.getElementById('attendeeModal');
        const attendeeModalContent = document.getElementById('attendeeModalContent');
        const modalBody = document.getElementById('modalBody');
        const closeAttendeeModalButton = document.getElementById('closeAttendeeModalButton');
        const closeAttendeeModalFooterButton = document.getElementById('closeAttendeeModalFooterButton');
        const demoRequestedButton = document.getElementById('demoRequestedButton');
        const demoRequestedButtonText = document.getElementById('demoRequestedButtonText');
        const demoRequestedCheckmark = document.getElementById('demoRequestedCheckmark');


        const filterModal = document.getElementById('filterModal');
        const closeFilterModalButton = document.getElementById('closeFilterModalButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const filterType = document.getElementById('filterType');
        const filterFocusAccount = document.getElementById('filterFocusAccount');
        const filterAE = document.getElementById('filterAE'); 
        const filterSDR = document.getElementById('filterSDR'); 

        const metricsModal = document.getElementById('metricsModal');
        const closeMetricsModalButton = document.getElementById('closeMetricsModalButton');
        const closeMetricsModalFooterButton = document.getElementById('closeMetricsModalFooterButton');
        const totalAttendeesCountEl = document.getElementById('totalAttendeesCount');
        const sdrChartCanvas = document.getElementById('sdrChart');
        const aeChartCanvas = document.getElementById('aeChart');
        const attendeeTypeChartCanvas = document.getElementById('attendeeTypeChart');
        const demoRequestsTableBody = document.getElementById('demoRequestsTableBody');
        const noDemoRequestsMessage = document.getElementById('noDemoRequestsMessage');
        const downloadDemoRequestsCsvButton = document.getElementById('downloadDemoRequestsCsvButton');


        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryFetchButton = document.getElementById('retryFetchButton');
        const attendeesTableContainer = document.getElementById('attendeesTableContainer');

        let allAttendees = [];
        let currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
        let currentSearchTerm = '';
        let currentAttendeeForDemo = null;
        let currentUserNameFromStorage = '';


        let sdrChartInstance = null;
        let aeChartInstance = null;
        let attendeeTypeChartInstance = null;

        let db;
        let auth;
        let currentUserId; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyCRGbSyg71HdQf-zMrjT9Vz9iaCU3cKOPw",
            authDomain: "attendeetrackerapp.firebaseapp.com",
            projectId: "attendeetrackerapp",
            storageBucket: "attendeetrackerapp.appspot.com", 
            messagingSenderId: "301064425215",
            appId: "1:301064425215:web:17fd2b66cd2e47d9b0c6ca"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendee-app'; 
        
        setLogLevel('debug'); 

        const headerMapping = {
            'First Name': 'firstName', 'Last Name': 'lastName', 'Email': 'email', 'Phone': 'phone',
            'Company': 'company', 'Job Title': 'jobTitle', 'Type': 'type', 
            'Focus Account': 'focusAccount', 'On-ground AE': 'onGroundAE', 'On-ground SDR': 'onGroundSDR',
            'Notes': 'notes'
        };
        const expectedHeaders = Object.keys(headerMapping);

        Chart.register({
            id: 'customDataLabelsOnTop',
            afterDatasetsDraw: (chart, args, options) => {
                const { ctx, data, _metasets } = chart;
                ctx.save();
                ctx.font = options.font || '12px Arial';
                ctx.fillStyle = options.color || 'black';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                for (let i = 0; i < data.datasets.length; i++) {
                    const dataset = data.datasets[i];
                    const meta = _metasets[i];
                    if (meta.hidden) continue;

                    for (let j = 0; j < meta.data.length; j++) {
                        const element = meta.data[j];
                        const value = dataset.data[j];
                        if (value !== null && value !== undefined) { 
                             ctx.fillText(value.toString(), element.x, element.y - (options.padding || 5));
                        }
                    }
                }
                ctx.restore();
            }
        });


        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && (i === 0 || line[i-1] !== '\\')) { 
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') { current += '"'; i++; } 
                    else { inQuotes = !inQuotes; }
                } else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } 
                else { current += char; }
            }
            result.push(current.trim());
            return result.map(value => value.replace(/^"|"$/g, '').replace(/""/g, '"'));
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); 
            if (lines.length === 0) return [];
            const rawHeaders = parseCSVLine(lines[0]); const data = [];
            const actualHeaders = rawHeaders.map(h => h.trim());
            
            const coreExpectedHeaders = Object.keys(headerMapping).filter(h => h !== 'Demo Requested' && h !== 'Demo Requested By');
            const missingCoreHeaders = coreExpectedHeaders.filter(eh => !actualHeaders.includes(eh)); 
            if (missingCoreHeaders.length > 0) {
                 console.warn('Core CSV headers missing/mismatched. Expected:', missingCoreHeaders, 'Actual:', actualHeaders);
            }

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; 
                const values = parseCSVLine(lines[i]); const entry = {}; let isEmptyRow = true; 
                const numVals = Math.min(values.length, actualHeaders.length);
                for(let j = 0; j < numVals; j++) {
                    const header = actualHeaders[j];
                    const mappedKey = headerMapping[header.trim()] || header.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); 
                    entry[mappedKey] = values[j] || '';
                    if (values[j] && values[j].trim() !== '') isEmptyRow = false;
                }
                if (!isEmptyRow) data.push(entry);
            }
            return data;
        }
        
        function populateFilterDropdowns(attendees) {
            const uniqueAEs = new Set(); const uniqueSDRs = new Set();
            attendees.forEach(att => {
                if (att.onGroundAE && att.onGroundAE.trim() !== '') uniqueAEs.add(att.onGroundAE.trim());
                if (att.onGroundSDR && att.onGroundSDR.trim() !== '') uniqueSDRs.add(att.onGroundSDR.trim());
            });
            filterAE.innerHTML = '<option value="All">All AEs</option>'; 
            Array.from(uniqueAEs).sort().forEach(ae => { const opt = document.createElement('option'); opt.value = ae; opt.textContent = ae; filterAE.appendChild(opt); });
            filterSDR.innerHTML = '<option value="All">All SDRs</option>'; 
            Array.from(uniqueSDRs).sort().forEach(sdr => { const opt = document.createElement('option'); opt.value = sdr; opt.textContent = sdr; filterSDR.appendChild(opt); });
        }
        
        function sanitizeForFirestoreId(id) {
            if (!id) return `unknown_id_${crypto.randomUUID()}`; 
            return id.replace(/[^a-zA-Z0-9_.-]/g, '_');
        }

        async function fetchAttendees() {
            showLoading(true); showError(false); let fetchSucceeded = false;
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL + `&t=${new Date().getTime()}`); 
                if (!response.ok) {
                    let errMsg = `HTTP error! Status: ${response.status}.`;
                    // ... (error handling for fetch status)
                    throw new Error(errMsg);
                }
                const csvText = await response.text();
                let parsedAtt = (csvText.trim() === '') ? [] : parseCSV(csvText);
                
                const attendeesWithDemoStatus = await Promise.all(parsedAtt.map(async (attendee) => {
                    let demoRequested = false;
                    let demoRequestedBy = '';
                    if (db && currentUserId && attendee.email) {
                        const safeEmailId = sanitizeForFirestoreId(attendee.email);
                        const demoStatusRef = doc(db, "artifacts", appId, "public/data/globalAttendeeDemoStatus", safeEmailId); // Updated path
                        try {
                            const docSnap = await getDoc(demoStatusRef);
                            if (docSnap.exists()) {
                                demoRequested = docSnap.data().requested === true;
                                demoRequestedBy = docSnap.data().requestedBy || '';
                            }
                        } catch (fsError) {
                            console.error("Error fetching demo status for", attendee.email, fsError);
                        }
                    }
                    return { ...attendee, demoRequested, demoRequestedBy };
                }));

                allAttendees = attendeesWithDemoStatus.filter(att => (att.firstName && att.firstName.trim() !== '') || (att.lastName && att.lastName.trim() !== '') || (att.company && att.company.trim() !== '') || (att.jobTitle && att.jobTitle.trim() !== '') );
                
                homeScreenTotalAttendeesCount.textContent = allAttendees.length;
                
                populateFilterDropdowns(allAttendees); 
                fetchSucceeded = true;
            } catch (error) { 
                console.error('Error fetching attendees:', error);
                let userFriendlyMessage = `Failed to load attendee data: ${error.message}.`;
                if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                    userFriendlyMessage = 'Failed to fetch attendee data. This could be a network issue, or the Google Sheet URL might be temporarily inaccessible or blocked. Please check your internet connection and ensure the Google Sheet is correctly published and publicly accessible via its CSV link. Try refreshing the page.';
                }
                showError(userFriendlyMessage);
            } finally { 
                showLoading(false); 
                if (fetchSucceeded) {
                    applyFiltersAndSearch(); 
                }
            }
        }

        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            attendeesTableContainer.classList.toggle('hidden', isLoading);
            noAttendeesMessage.classList.toggle('hidden', isLoading); 
        }
        function showError(show, message = '') {
            errorText.textContent = message; errorMessage.classList.toggle('hidden', !show);
            attendeesTableContainer.classList.toggle('hidden', show); 
            noAttendeesMessage.classList.toggle('hidden', show); 
        }

        function renderTable(attendeesToRender) {
            attendeesTableBody.innerHTML = ''; 
            const tableHeader = attendeesTableContainer.querySelector('table thead');
            if (attendeesToRender.length === 0) { noAttendeesMessage.classList.remove('hidden'); tableHeader.classList.add('hidden'); } 
            else {
                noAttendeesMessage.classList.add('hidden'); tableHeader.classList.remove('hidden'); 
                attendeesToRender.forEach((attendee, index) => {
                    const row = attendeesTableBody.insertRow();
                    row.className = 'hover:bg-gray-100 cursor-pointer transition-colors no-select';
                    if (attendee.demoRequested) { 
                        row.classList.add('demo-requested-row-active');
                    }

                    const originalAttendeeRef = allAttendees.find(orig => orig.email === attendee.email && orig.firstName === attendee.firstName && orig.lastName === attendee.lastName);
                    const dataId = originalAttendeeRef ? allAttendees.indexOf(originalAttendeeRef) : index; 
                    row.setAttribute('data-id', dataId); 
                    const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
                    const cellName = row.insertCell();
                    const cellCompany = row.insertCell();
                    const cellTitle = row.insertCell();

                    cellName.textContent = fullName || 'N/A';
                    cellCompany.textContent = attendee.company || 'N/A';
                    cellTitle.textContent = attendee.jobTitle || 'N/A';

                    Array.from(row.cells).forEach(cell => {
                        cell.className = 'px-6 py-4 text-sm text-gray-700 break-words';
                    });
                    
                    row.addEventListener('click', () => openAttendeeDetailModal(attendee));
                });
            }
        }
        
        function copyToClipboard(text, feedbackElement) {
            const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); if(feedbackElement) { feedbackElement.textContent = 'Copied!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            catch (err) { console.error('Copy failed: ', err); if(feedbackElement) { feedbackElement.textContent = 'Copy failed!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            document.body.removeChild(ta);
        }

        function updateDemoRequestedButtonUI(isRequested) {
            if (isRequested) {
                demoRequestedButtonText.textContent = 'Requested';
                demoRequestedCheckmark.classList.remove('hidden');
                demoRequestedButton.classList.add('bg-gray-300', 'hover:bg-gray-300', 'text-gray-500'); 
                demoRequestedButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                attendeeModalContent.classList.add('demo-requested-active');
            } else {
                demoRequestedButtonText.textContent = 'Demo Requested';
                demoRequestedCheckmark.classList.add('hidden');
                demoRequestedButton.classList.remove('bg-gray-300', 'hover:bg-gray-300', 'text-gray-500');
                demoRequestedButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
                attendeeModalContent.classList.remove('demo-requested-active');
            }
        }


        function openAttendeeDetailModal(attendee) {
            currentAttendeeForDemo = attendee; 
            modalBody.innerHTML = ''; 
            const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
            const createDetailRow = (label, value, type = 'text') => {
                if (value && value.trim() !== '') { 
                    const div = document.createElement('div'); div.className = 'grid grid-cols-3 gap-2 items-center';
                    const lbl = document.createElement('p'); lbl.className = 'text-sm font-medium text-gray-500 col-span-1 break-words'; lbl.textContent = label + ':'; div.appendChild(lbl);
                    const valCont = document.createElement('div'); valCont.className = 'text-sm text-gray-900 col-span-2 break-words flex items-center';
                    if (type === 'tel' && value) { const a = document.createElement('a'); a.href = `tel:${value.replace(/\s+/g, '')}`; a.textContent = value; a.className = 'text-blue-600 hover:text-blue-800 hover:underline'; valCont.appendChild(a); } 
                    else if (type === 'email' && value) {
                        const emSpan = document.createElement('span'); emSpan.textContent = value; emSpan.className = 'text-blue-600 hover:text-blue-800 hover:underline cursor-pointer';
                        const fbSpan = document.createElement('span'); fbSpan.className = 'copy-feedback';
                        emSpan.addEventListener('click', () => copyToClipboard(value, fbSpan));
                        valCont.appendChild(emSpan); valCont.appendChild(fbSpan);
                    } else { const p = document.createElement('p'); p.innerHTML = value.replace(/\n/g, '<br>'); valCont.appendChild(p); } 
                    div.appendChild(valCont); modalBody.appendChild(div);
                }
            };
            createDetailRow('Full Name', fullName); createDetailRow('Email', attendee.email, 'email'); createDetailRow('Phone', attendee.phone, 'tel');
            createDetailRow('Company', attendee.company); createDetailRow('Job Title', attendee.jobTitle); createDetailRow('Type', attendee.type);
            createDetailRow('Focus Account', attendee.focusAccount); createDetailRow('On-ground AE', attendee.onGroundAE); createDetailRow('On-ground SDR', attendee.onGroundSDR);
            createDetailRow('Notes', attendee.notes);
            
            updateDemoRequestedButtonUI(attendee.demoRequested === true);
            attendeeModal.classList.remove('hidden');
        }
        function closeAttendeeDetailModal() { 
            attendeeModal.classList.add('hidden');
            currentAttendeeForDemo = null; 
            attendeeModalContent.classList.remove('demo-requested-active');
        }
        
        function openFilterModal() {
            filterType.value = currentFilters.type; filterFocusAccount.value = currentFilters.focusAccount;
            filterAE.value = currentFilters.onGroundAE; filterSDR.value = currentFilters.onGroundSDR; 
            filterModal.classList.remove('hidden');
        }
        function closeFilterModal() { filterModal.classList.add('hidden'); }

        function createOrUpdateChart(chartInstance, canvasElement, chartType, data, options) {
            if (chartInstance) { chartInstance.destroy(); }
            return new Chart(canvasElement, { type: chartType, data: data, options: options });
        }

        function openMetricsModal() {
            totalAttendeesCountEl.textContent = allAttendees.length; 
            const sdrCounts = {}; const aeCounts = {};
            const typeCounts = { 'Prospect': 0, 'Partner': 0, 'Customer': 0 };
            const demoRequestedAttendees = [];

            allAttendees.forEach(attendee => {
                const sdr = attendee.onGroundSDR?.trim();
                const ae = attendee.onGroundAE?.trim();
                const type = attendee.type?.trim();
                if (sdr) sdrCounts[sdr] = (sdrCounts[sdr] || 0) + 1;
                if (ae) aeCounts[ae] = (aeCounts[ae] || 0) + 1;
                if (type && typeCounts.hasOwnProperty(type)) typeCounts[type]++;
                if (attendee.demoRequested === true) { 
                    demoRequestedAttendees.push(attendee);
                }
            });

            const chartOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { display: false, beginAtZero: true },
                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                }, 
                plugins: { 
                    legend: { display: false },
                    customDataLabelsOnTop: { color: '#333', font: 'bold 12px Arial', padding: 6 }
                }, 
                animation: false 
            };
            
            const sdrChartData = { labels: Object.keys(sdrCounts), datasets: [{ label: 'Attendees by SDR', data: Object.values(sdrCounts), backgroundColor: '#0abd57', borderColor: '#0abd57', borderWidth: 1 }] };
            sdrChartInstance = createOrUpdateChart(sdrChartInstance, sdrChartCanvas, 'bar', sdrChartData, chartOptions);

            const aeChartData = { labels: Object.keys(aeCounts), datasets: [{ label: 'Attendees by AE', data: Object.values(aeCounts), backgroundColor: '#17494c', borderColor: '#17494c', borderWidth: 1 }] };
            aeChartInstance = createOrUpdateChart(aeChartInstance, aeChartCanvas, 'bar', aeChartData, chartOptions);
            
            const attendeeTypeChartData = { labels: Object.keys(typeCounts), datasets: [{ label: 'Attendees by Type', data: Object.values(typeCounts), backgroundColor: ['#0abd57', '#17494c', '#000000'], borderColor: ['#0abd57', '#17494c', '#000000'], borderWidth: 1 }] };
            attendeeTypeChartInstance = createOrUpdateChart(attendeeTypeChartInstance, attendeeTypeChartCanvas, 'bar', attendeeTypeChartData, chartOptions);

            demoRequestsTableBody.innerHTML = '';
            if (demoRequestedAttendees.length > 0) {
                noDemoRequestsMessage.classList.add('hidden');
                demoRequestsTableContainer.querySelector('table thead').classList.remove('hidden');
                demoRequestedAttendees.forEach(attendee => {
                    const row = demoRequestsTableBody.insertRow();
                    const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
                    row.insertCell().textContent = fullName || 'N/A';
                    row.insertCell().textContent = attendee.company || 'N/A';
                    row.insertCell().textContent = attendee.jobTitle || 'N/A';
                    row.insertCell().textContent = attendee.demoRequestedBy || 'N/A'; 
                    Array.from(row.cells).forEach(cell => cell.className = 'px-6 py-3 whitespace-nowrap text-sm text-gray-700');
                });
            } else {
                noDemoRequestsMessage.classList.remove('hidden');
                demoRequestsTableContainer.querySelector('table thead').classList.add('hidden');
            }

            metricsModal.classList.remove('hidden');
        }
        function closeMetricsModal() { metricsModal.classList.add('hidden'); }

        function applyFiltersAndSearch() {
            let filtered = [...allAttendees]; 
            filtered = filtered.filter(att => 
                (currentFilters.type === 'All' || (att.type && att.type.toLowerCase() === currentFilters.type.toLowerCase())) &&
                (currentFilters.focusAccount === 'All' || (att.focusAccount && att.focusAccount.toLowerCase() === currentFilters.focusAccount.toLowerCase())) &&
                (currentFilters.onGroundAE === 'All' || (att.onGroundAE && att.onGroundAE === currentFilters.onGroundAE)) && 
                (currentFilters.onGroundSDR === 'All' || (att.onGroundSDR && att.onGroundSDR === currentFilters.onGroundSDR))   
            );
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(att =>
                    (`${att.firstName || ''} ${att.lastName || ''}`.toLowerCase().includes(searchTermLower)) ||
                    ((att.company || '').toLowerCase().includes(searchTermLower)) ||
                    ((att.jobTitle || '').toLowerCase().includes(searchTermLower))
                );
            }
            // Sort by check-in time (reverse order of how they appear in the sheet)
            filtered.reverse(); 

            if (!loadingSpinner.classList.contains('hidden') || !errorMessage.classList.contains('hidden')) {} 
            else { attendeesTableContainer.classList.remove('hidden'); renderTable(filtered); }
        }

        async function saveUserName(name) {
            currentUserNameFromStorage = name; 
            if (!db || !currentUserId) {
                console.warn("Firestore not initialized or user ID not available for saving name. Name not saved to cloud.");
                return;
            }
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId, "userData", "profile");
            try {
                await setDoc(userDocRef, { firstName: name }, { merge: true });
                console.log("User name saved to Firestore for user:", currentUserId);
            } catch (error) {
                console.error("Error saving user name to Firestore:", error);
            }
        }
        
        async function getUserNameFromFirestore() {
            if (!db || !currentUserId) {
                console.warn("Firestore not initialized or user ID not available for getting name.");
                return null;
            }
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId, "userData", "profile");
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    return docSnap.data().firstName;
                }
                return null;
            } catch (error) {
                console.error("Error getting user name from Firestore:", error);
                return null;
            }
        }

        async function toggleDemoRequest(attendee) {
            if (!db || !currentUserId || !attendee || !attendee.email) {
                console.error(
                    "toggleDemoRequest PRE-CONDITION FAILED:", 
                    "\n  Firestore (db) ready:", !!db,
                    "\n  Current User ID (currentUserId):", currentUserId,
                    "\n  Attendee object present (attendee):", !!attendee,
                    "\n  Attendee email (attendee?.email):", attendee?.email
                );
                alert("Could not update demo request status. Firestore/Auth not ready or attendee email is missing. Please try again or check console for details. Ensure Firebase is correctly configured in your environment if self-hosting.");
                return;
            }
            const safeEmailId = sanitizeForFirestoreId(attendee.email);
            const demoStatusRef = doc(db, "artifacts", appId, "public/data/globalAttendeeDemoStatus", safeEmailId); // Use public path
            
            const newDemoStatus = !(attendee.demoRequested === true); 

            try {
                if (newDemoStatus) {
                    await setDoc(demoStatusRef, { 
                        requested: true, 
                        requestedBy: currentUserNameFromStorage || "Unknown User",
                        requestedByUserId: currentUserId, // Store the ID of the user who made the request
                        timestamp: new Date().toISOString() 
                    });
                } else {
                    await deleteDoc(demoStatusRef); 
                }
                
                const attendeeInGlobalArray = allAttendees.find(a => a.email === attendee.email);
                if (attendeeInGlobalArray) {
                    attendeeInGlobalArray.demoRequested = newDemoStatus;
                    attendeeInGlobalArray.demoRequestedBy = newDemoStatus ? (currentUserNameFromStorage || "Unknown User") : '';
                } else { 
                    attendee.demoRequested = newDemoStatus; 
                    attendee.demoRequestedBy = newDemoStatus ? (currentUserNameFromStorage || "Unknown User") : '';
                }
                
                updateDemoRequestedButtonUI(newDemoStatus);
                console.log(`Demo request for ${attendee.email} set to ${newDemoStatus} by ${currentUserNameFromStorage}`);
                
                applyFiltersAndSearch(); 
                if (!metricsModal.classList.contains('hidden')) {
                    openMetricsModal();
                }

            } catch (error) {
                console.error("Error updating demo request status in Firestore:", error);
                alert(`Failed to update demo request status: ${error.message}. Please check console for more details and ensure Firebase is correctly set up (especially Firestore rules).`);
            }
        }

        function downloadCSV(data, filename = 'demo-requests.csv') {
            const csvHeader = "First Name,Last Name,Company,Job Title,Email Address,Phone,Type,Focus Account,On-ground SDR,On-ground AE,Demo Requested By\n";
            const csvRows = data.map(row => {
                return [
                    `"${(row.firstName || '').replace(/"/g, '""')}"`,
                    `"${(row.lastName || '').replace(/"/g, '""')}"`,
                    `"${(row.company || '').replace(/"/g, '""')}"`,
                    `"${(row.jobTitle || '').replace(/"/g, '""')}"`,
                    `"${(row.email || '').replace(/"/g, '""')}"`,
                    `"${(row.phone || '').replace(/"/g, '""')}"`,
                    `"${(row.type || '').replace(/"/g, '""')}"`,
                    `"${(row.focusAccount || '').replace(/"/g, '""')}"`,
                    `"${(row.onGroundSDR || '').replace(/"/g, '""')}"`,
                    `"${(row.onGroundAE || '').replace(/"/g, '""')}"`,
                    `"${(row.demoRequestedBy || '').replace(/"/g, '""')}"`
                ].join(',');
            }).join('\n');

            const csvString = csvHeader + csvRows;
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        async function initializeAppLogic() {
            let configErrorMessage = "Application critical error: Firebase configuration is incomplete or uses placeholders. ";
            let configIsInvalid = false;
            const placeholderValues = { 
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT_ID.appspot.com",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_FIREBASE_APP_ID"
            };

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                configErrorMessage += "The entire firebaseConfig object is missing. ";
                configIsInvalid = true;
            } else {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === placeholderValues.apiKey || (firebaseConfig.apiKey.startsWith("AIzaSy") && firebaseConfig.apiKey.length < 39) ){
                     if (firebaseConfig.apiKey !== "AIzaSyCRGbSyg71HdQf-zMrjT9Vz9iaCU3cKOPw") {configErrorMessage += "The Firebase API key appears to be a placeholder or is missing/invalid. "; configIsInvalid = true;}
                }
                if (!firebaseConfig.authDomain || firebaseConfig.authDomain.includes("YOUR_PROJECT_ID") || firebaseConfig.authDomain.trim() === "" || firebaseConfig.authDomain === placeholderValues.authDomain) {
                     if (firebaseConfig.authDomain !== "attendeetrackerapp.firebaseapp.com") {configErrorMessage += "The Firebase authDomain is missing or is a placeholder. "; configIsInvalid = true;}
                }
                if (!firebaseConfig.projectId || firebaseConfig.projectId === placeholderValues.projectId || firebaseConfig.projectId.trim() === "") {
                     if (firebaseConfig.projectId !== "attendeetrackerapp") {configErrorMessage += "The Firebase projectId is missing or is a placeholder. "; configIsInvalid = true;}
                }
                 if (!firebaseConfig.storageBucket || firebaseConfig.storageBucket.includes("YOUR_PROJECT_ID") || firebaseConfig.storageBucket === placeholderValues.storageBucket || firebaseConfig.storageBucket.trim() === "") {
                     if (firebaseConfig.storageBucket !== "attendeetrackerapp.appspot.com") {configErrorMessage += "The Firebase storageBucket is missing or is a placeholder. "; configIsInvalid = true;}
                }
                 if (!firebaseConfig.messagingSenderId || firebaseConfig.messagingSenderId === placeholderValues.messagingSenderId || firebaseConfig.messagingSenderId.trim() === "") {
                     if (firebaseConfig.messagingSenderId !== "301064425215") {configErrorMessage += "The Firebase messagingSenderId is missing or is a placeholder. "; configIsInvalid = true;}
                }
                 if (!firebaseConfig.appId || firebaseConfig.appId.includes("YOUR_FIREBASE_APP_ID") || firebaseConfig.appId === placeholderValues.appId || firebaseConfig.appId.trim() === "") {
                    if (firebaseConfig.appId !== "1:301064425215:web:17fd2b66cd2e47d9b0c6ca") {configErrorMessage += "The Firebase appId is missing or is a placeholder. "; configIsInvalid = true;}
                }
            }
            
            if (configIsInvalid) {
                configErrorMessage += "Please ensure all values in the 'firebaseConfig' object in the script (around line 280) are correctly set with your actual project credentials from the Firebase Console.";
                console.error("FATAL: " + configErrorMessage);
                alert(configErrorMessage);

                welcomeScreen.classList.remove('hidden'); 
                mainAppContent.classList.add('hidden');
                enterAppButton.onclick = () => { 
                    localStorage.setItem('attendeeAppWelcomeCompleted', 'true'); 
                    localStorage.setItem('attendeeAppUserName', userNameInput.value.trim()); 
                    currentUserNameFromStorage = userNameInput.value.trim();
                    welcomeScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                    fetchAttendees(); 
                    setInterval(fetchAttendees, POLLING_INTERVAL);
                };
                currentUserNameFromStorage = localStorage.getItem('attendeeAppUserName');
                if (localStorage.getItem('attendeeAppWelcomeCompleted') === 'true' && currentUserNameFromStorage) {
                     welcomeScreen.classList.add('hidden');
                     mainAppContent.classList.remove('hidden');
                     fetchAttendees(); 
                     setInterval(fetchAttendees, POLLING_INTERVAL);
                }
                return; 
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                   try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } catch (customTokenError) {
                        console.warn("Custom token sign-in failed:", customTokenError.code, customTokenError.message, ". This can happen if the token is for a different Firebase project than configured in firebaseConfig, or if the token is malformed/expired. Falling back to anonymous sign-in.");
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously after custom token failure.");
                    }
                } else {
                    console.log("Attempting to sign in anonymously (no custom token provided)...");
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                currentUserId = auth.currentUser?.uid; 
                if (!currentUserId) { 
                    console.warn("Firebase User ID not available after sign-in attempt. Using a temporary local ID for this session if name needs to be saved.");
                    currentUserId = `local-${crypto.randomUUID()}`;
                }
                console.log("Firebase Initialized. User ID for this session:", currentUserId);
                currentUserNameFromStorage = await getUserNameFromFirestore(); 
            } catch (error) {
                console.error("Critical Error during Firebase initialization or Auth:", error);
                let specificErrorAlert = "Could not connect to essential services. Saving your name to the cloud will be unavailable. App will use local storage for welcome screen preference. Error: " + error.message;
                if (error.code === 'auth/configuration-not-found') {
                    specificErrorAlert = "Firebase Authentication configuration error (auth/configuration-not-found). This means the details in 'firebaseConfig' (apiKey, authDomain, projectId, etc.) are incorrect or not recognized by Firebase. Please METICULOUSLY verify these values in the script against your Firebase project console. Also, ensure Anonymous sign-in is enabled in your Firebase project's Authentication settings.";
                }
                alert(specificErrorAlert);
                db = null; auth = null; currentUserId = `local-${crypto.randomUUID()}`; 
            }

            if (localStorage.getItem('attendeeAppWelcomeCompleted') === 'true' && currentUserNameFromStorage) {
                welcomeScreen.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
                fetchAttendees(); 
                setInterval(fetchAttendees, POLLING_INTERVAL);
            } else {
                 if (localStorage.getItem('attendeeAppWelcomeCompleted') === 'true' && !currentUserNameFromStorage) {
                    localStorage.removeItem('attendeeAppWelcomeCompleted'); 
                }
                welcomeScreen.classList.remove('hidden');
                mainAppContent.classList.add('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();

            enterAppButton.addEventListener('click', async () => {
                const name = userNameInput.value.trim();
                if (name) {
                    await saveUserName(name); 
                    localStorage.setItem('attendeeAppWelcomeCompleted', 'true'); 
                    
                    welcomeScreen.classList.add('hidden');
                    mainAppContent.classList.remove('hidden');
                    fetchAttendees(); 
                    setInterval(fetchAttendees, POLLING_INTERVAL);
                } else {
                    alert("Please enter your first name.");
                }
            });
            
            searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFiltersAndSearch(); });
            filterButton.addEventListener('click', openFilterModal);
            metricsButton.addEventListener('click', openMetricsModal);
            
            demoRequestedButton.addEventListener('click', async () => {
                if (currentAttendeeForDemo) {
                    await toggleDemoRequest(currentAttendeeForDemo);
                }
            });
            
            closeAttendeeModalButton.addEventListener('click', closeAttendeeDetailModal);
            closeAttendeeModalFooterButton.addEventListener('click', closeAttendeeDetailModal);
            attendeeModal.addEventListener('click', (e) => { if (e.target === attendeeModalContent || attendeeModalContent.contains(e.target)) return; closeAttendeeDetailModal(); });
            
            closeFilterModalButton.addEventListener('click', closeFilterModal);
            filterModal.addEventListener('click', (e) => { if (e.target === filterModal) closeFilterModal(); });
            
            closeMetricsModalButton.addEventListener('click', closeMetricsModal);
            closeMetricsModalFooterButton.addEventListener('click', closeMetricsModal);
            metricsModal.addEventListener('click', (e) => { if (e.target === metricsModal) closeMetricsModal(); });

            downloadDemoRequestsCsvButton.addEventListener('click', () => {
                const demoRequestedAttendees = allAttendees.filter(att => att.demoRequested === true);
                if (demoRequestedAttendees.length > 0) {
                    downloadCSV(demoRequestedAttendees);
                } else {
                    alert("No demo requests to download.");
                }
            });

            applyFiltersButton.addEventListener('click', () => {
                currentFilters.type = filterType.value; currentFilters.focusAccount = filterFocusAccount.value;
                currentFilters.onGroundAE = filterAE.value; currentFilters.onGroundSDR = filterSDR.value; 
                applyFiltersAndSearch(); closeFilterModal();
            });
            clearFiltersButton.addEventListener('click', () => {
                filterType.value = 'All'; filterFocusAccount.value = 'All';
                filterAE.value = 'All'; filterSDR.value = 'All'; 
                currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
                applyFiltersAndSearch(); 
                closeFilterModal();
            });
            retryFetchButton.addEventListener('click', () => { showError(false); fetchAttendees(); });
        });
    </script>
</body>
</html>

