<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Attendee Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        img { max-width: 100%; height: auto; }
        .copy-feedback { font-size: 0.75rem; color: #10B981; margin-left: 8px; display: inline-block; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .side-by-side-charts .chart-container { max-width: 100%; }
        .demo-requested-active { background-color: #cffde3 !important; }
        .demo-requested-row-active { background-color: #cffde3; }
        .demo-requested-row-active:hover { background-color: #b6f7d0 !important; }
        .attendee-count-text { color: #16484d; }
        .info-icon { cursor: help; color: #60a5fa; /* blue-400 */ margin-left: 4px; }
        .tooltip { visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 130%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .info-icon-container:hover .tooltip { visibility: visible; opacity: 1; }
        .grid-tile { background-color: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; display: flex; flex-direction: column; justify-content: space-between; height: 100%;}
        .grid-tile:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .grid-tile img { max-height: 100px; object-fit: contain; margin-bottom: 0.5rem; margin-left: auto; margin-right: auto;}
        /* Notification Toast Styling */
        #notificationToast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 200;
            transition: top 0.5s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #notificationToast.show {
            top: 20px;
        }
        .bg-success { background-color: #10B981; } /* green-500 */
        .bg-error { background-color: #EF4444; } /* red-500 */
        .bg-info { background-color: #3B82F6; } /* blue-500 */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Notification Toast -->
    <div id="notificationToast"></div>

    <!-- Welcome Screen / Initial Login -->
    <div id="welcomeScreen" class="fixed inset-0 bg-gray-100 z-[100] flex flex-col items-center justify-center p-8">
        <img src="https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" alt="Event Banner" class="max-w-xs md:max-w-md h-auto mx-auto rounded-lg mb-8" onerror="this.onerror=null; this.src='https://placehold.co/400x150/cccccc/333333?text=Event+Banner';">
        <div id="initialLoginOptions" class="w-full max-w-sm">
            <p class="text-3xl md:text-4xl font-bold text-gray-700 mb-4 text-center">Welcome</p>
            <div id="userNamePrompt">
                <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-1">Please enter your first name:</label>
                <input type="text" id="userNameInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Your First Name">
                <button id="enterAppButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all mb-3">Enter</button>
            </div>
            <div id="returningUserOptions" class="hidden">
                <p id="welcomeBackMessage" class="text-lg text-gray-700 mb-4 text-center"></p>
                <button id="viewEventsButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all mb-3">View Events</button>
            </div>
            <button id="adminControlsLoginButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">Admin Controls</button>
        </div>
    </div>

    <!-- Admin Login Screen -->
    <div id="adminLoginScreen" class="fixed inset-0 bg-gray-100 z-[90] flex flex-col items-center justify-center p-8 hidden">
        <img src="https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" alt="Event Banner" class="max-w-xs md:max-w-sm h-auto mx-auto rounded-lg mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Admin Login</h2>
        <div class="w-full max-w-sm bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label for="adminUsername" class="block text-sm font-medium text-gray-700">Username</label>
                <select id="adminUsername" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="mb-6">
                <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="adminPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button id="adminLoginSubmitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Submit</button>
            <button id="backToWelcomeFromAdminLoginButton" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Back</button>
        </div>
    </div>

    <!-- Admin Controls Page -->
    <div id="adminControlsScreen" class="container mx-auto p-4 md:p-8 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Admin Controls</h1>
            <button id="adminLogoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Logout</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="addEventTile" class="grid-tile">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-calendar-plus mx-auto mb-2 text-indigo-600" viewBox="0 0 16 16"><path d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>
                <h3 class="text-xl font-semibold text-gray-800">Add Event</h3>
                <p class="text-sm text-gray-600">Create a new event profile.</p>
            </div>
            <div id="manageEventsTile" class="grid-tile">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-pencil-square mx-auto mb-2 text-indigo-600" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.636a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.813z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                <h3 class="text-xl font-semibold text-gray-800">Manage Events</h3>
                <p class="text-sm text-gray-600">View, edit, or delete existing events.</p>
            </div>
        </div>
    </div>
    
    <div id="eventSelectionScreen" class="container mx-auto p-4 md:p-8 hidden">
         <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Select an Event</h1>
            <button id="userLogoutButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Change User</button>
        </div>
        <div id="eventTilesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
         <p id="noEventsToShowMessage" class="text-center text-gray-500 py-10 hidden">No events available at the moment. Please check back later.</p>
    </div>

    <div id="mainAppContent" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-6 text-center">
            <img id="eventSpecificBanner" src="https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" alt="Event Banner" class="max-w-xs h-auto mx-auto rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';">
        </header>
        <button id="backToEventSelectionButton" class="mb-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">&larr; Back to Events</button>
        <main class="bg-white p-6 rounded-lg shadow-xl">
            <h1 id="eventSpecificTitle" class="text-2xl md:text-3xl font-bold text-gray-700 mb-2 text-center">Event Name</h1>
            <div id="attendeeStatusDisplay" class="text-center mb-6 p-3 rounded-lg attendee-count-text">
                <span id="eventStatusIndicator" class="inline-block w-3 h-3 rounded-full mr-2 hidden"></span>
                <span id="homeScreenTotalAttendeesCount" class="text-2xl font-bold">0</span>
                <span class="text-xl"> checked-in attendees</span>
            </div>
            
            <div class="flex flex-col space-y-4 mb-6">
                <div class="relative w-full">
                    <input type="text" id="searchInput"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                           placeholder="Search by name, company, or job title...">
                    <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="flex space-x-2 md:space-x-4 w-full md:w-auto md:justify-start">
                     <button id="filterButton" style="background-color: #0abc58;" class="w-1/2 md:w-auto hover:opacity-90 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center text-sm">
                        <svg class="h-5 w-5 mr-1 md:mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" /></svg>
                        Filters
                    </button>
                    <button id="metricsButton" style="background-color: #16484d;" class="w-1/2 md:w-auto hover:opacity-90 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center text-sm">
                        <svg class="h-5 w-5 mr-1 md:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        Metrics
                    </button>
                </div>
            </div>

            <div id="loadingSpinner" class="text-center py-10 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                <p class="text-gray-600 mt-2">Loading attendees...</p>
            </div>
            <div id="errorMessage" class="text-center py-10 hidden bg-red-100 text-red-700 p-4 rounded-lg">
                <p id="errorText"></p>
                <button id="retryFetchButton" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Retry
                </button>
            </div>

            <div id="attendeesTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm table-fixed">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="w-[20%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
                <p id="noAttendeesMessage" class="text-center text-gray-500 py-10 hidden">No attendees checked in yet.</p>
            </div>
        </main>

        <div id="attendeeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div id="attendeeModalContent" class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Details</h3>
                    <button id="closeAttendeeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalBody" class="p-6 space-y-3 flex-grow overflow-y-auto">
                    </div>
                <!-- Gemini Icebreaker Section -->
                <div id="icebreakerSection" class="p-6 border-t border-gray-200 flex-shrink-0">
                    <button id="generateIcebreakerButton" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                        Generate Icebreaker ✨
                    </button>
                    <div id="icebreakerResult" class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-700 hidden"></div>
                    <div id="icebreakerSpinner" class="mt-4 flex justify-center hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                     <button id="demoRequestedButton" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <span id="demoRequestedButtonText">Demo Requested</span>
                        <span id="demoRequestedCheckmark" class="ml-2 hidden">✓</span>
                    </button>
                     <button id="closeAttendeeModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="filterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Filter Attendees</h3>
                    <button id="closeFilterModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="filterType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Prospect">Prospect</option> <option value="Partner">Partner</option> <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterFocusAccount" class="block text-sm font-medium text-gray-700 mb-1">Focus Account</label>
                        <select id="filterFocusAccount" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Yes">Yes</option> <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAE" class="block text-sm font-medium text-gray-700 mb-1">On-ground AE</label>
                        <select id="filterAE" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All AEs</option></select>
                    </div>
                    <div>
                        <label for="filterSDR" class="block text-sm font-medium text-gray-700 mb-1">On-ground SDR</label>
                         <select id="filterSDR" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All SDRs</option></select>
                    </div>
                    </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="clearFiltersButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">Clear Filters</button>
                    <button id="applyFiltersButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Apply Filters</button>
                </div>
            </div>
        </div>

        <div id="metricsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Metrics</h3>
                    <button id="closeMetricsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-6 flex-grow overflow-y-auto">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700">Total Checked-in: <span id="totalAttendeesCount" class="text-blue-600">0</span></h4>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts">
                        <div class="md:w-1/2 chart-container">
                             <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by SDR</h4>
                            <canvas id="sdrChart"></canvas>
                        </div>
                        <div class="md:w-1/2 chart-container">
                            <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by AE</h4>
                            <canvas id="aeChart"></canvas>
                        </div>
                    </div>
                     <div class="flex flex-col md:flex-row justify-center md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts mt-10">
                        <div class="md:w-1/2 chart-container"> <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by Type</h4>
                            <canvas id="attendeeTypeChart"></canvas>
                        </div>
                        </div>
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Demo Requests</h4>
                        <div id="demoRequestsTableContainer" class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                    </tr>
                                </thead>
                                <tbody id="demoRequestsTableBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                            <p id="noDemoRequestsMessage" class="text-center text-gray-500 py-6 hidden">No demo requests yet.</p>
                        </div>
                        <div class="mt-4 text-center">
                             <button id="downloadDemoRequestsCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Download Demo Requests CSV</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 text-right flex-shrink-0">
                     <button id="closeMetricsModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="addEventModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Add New Event</h3>
                    <button id="closeAddEventModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="addEventForm" class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="eventName" class="block text-sm font-medium text-gray-700">Event Name 
                            <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Add the public name of the event</span>
                            </span>
                        </label>
                        <input type="text" id="eventName" name="eventName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventCity" class="block text-sm font-medium text-gray-700">City
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Enter the city where the event is held.</span>
                            </span>
                        </label>
                        <input type="text" id="eventCity" name="eventCity" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">Event Date
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Select the date of the event.</span>
                            </span>
                        </label>
                        <input type="date" id="eventDate" name="eventDate" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventStartTime" class="block text-sm font-medium text-gray-700">Event Start Time
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Add the same start time as on the LP.</span>
                            </span>
                        </label>
                        <input type="time" id="eventStartTime" name="eventStartTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventEndTime" class="block text-sm font-medium text-gray-700">Event End Time
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Enter the end time of the event.</span>
                            </span>
                        </label>
                        <input type="time" id="eventEndTime" name="eventEndTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventSheetUrl" class="block text-sm font-medium text-gray-700">Source Sheet URL
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Paste the URL you receive after File > Share > Publish to Web in your Google Sheet (CSV output).</span>
                            </span>
                        </label>
                        <input type="url" id="eventSheetUrl" name="eventSheetUrl" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="eventBannerUrl" class="block text-sm font-medium text-gray-700">Event Banner Image URL
                             <span class="info-icon-container inline-block relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle info-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.196-.12L6.72 9.94l.24-.991.24.991.196.121.287-.47-.45-.082-.082.38.229-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip">Paste the public URL after uploading the transparent logo image on Hubspot.</span>
                            </span>
                        </label>
                        <input type="url" id="eventBannerUrl" name="eventBannerUrl" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </form>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="submitAddEventButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Submit Event</button>
                </div>
            </div>
        </div>

        <div id="manageEventsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-800">Manage Events</h3>
                    <button id="closeManageEventsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4 flex-grow overflow-y-auto">
                    <div>
                        <label for="manageEventDropdown" class="block text-sm font-medium text-gray-700 mb-1">Select Event to Manage</label>
                        <select id="manageEventDropdown" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                    <button id="deleteEventButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg mt-4">Delete Selected Event</button>
                </div>
                 <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                    <button id="doneManageEventsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Done</button>
                </div>
            </div>
        </div>
        
        <div id="customConfirmModal" class="fixed inset-0 z-[150] flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6">
                <h3 id="customConfirmTitle" class="text-lg font-semibold text-gray-800 mb-4">Confirm Action</h3>
                <p id="customConfirmMessage" class="text-sm text-gray-600 mb-6">Are you sure?</p>
                <div class="flex justify-end space-x-3">
                    <button id="customConfirmCancelButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="customConfirmOkButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
                </div>
            </div>
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Configuration
        let CURRENT_EVENT_GOOGLE_SHEET_URL = ''; 
        const POLLING_INTERVAL = 30000; 

        // DOM Elements (Consolidated)
        const screens = {
            welcome: document.getElementById('welcomeScreen'),
            adminLogin: document.getElementById('adminLoginScreen'),
            adminControls: document.getElementById('adminControlsScreen'),
            eventSelection: document.getElementById('eventSelectionScreen'),
            mainApp: document.getElementById('mainAppContent')
        };
        const initialLoginOptions = document.getElementById('initialLoginOptions');
        const userNamePrompt = document.getElementById('userNamePrompt');
        const returningUserOptions = document.getElementById('returningUserOptions');
        const welcomeBackMessage = document.getElementById('welcomeBackMessage');
        const viewEventsButton = document.getElementById('viewEventsButton');
        const adminControlsLoginButton = document.getElementById('adminControlsLoginButton');
        const userLogoutButton = document.getElementById('userLogoutButton');
        
        const adminUsernameSelect = document.getElementById('adminUsername');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminLoginSubmitButton = document.getElementById('adminLoginSubmitButton');
        const backToWelcomeFromAdminLoginButton = document.getElementById('backToWelcomeFromAdminLoginButton');

        const addEventTile = document.getElementById('addEventTile');
        const manageEventsTile = document.getElementById('manageEventsTile');
        const adminLogoutButton = document.getElementById('adminLogoutButton');

        const addEventModal = document.getElementById('addEventModal');
        const addEventForm = document.getElementById('addEventForm');
        const closeAddEventModalButton = document.getElementById('closeAddEventModalButton');
        const submitAddEventButton = document.getElementById('submitAddEventButton');

        const manageEventsModal = document.getElementById('manageEventsModal');
        const closeManageEventsModalButton = document.getElementById('closeManageEventsModalButton');
        const manageEventDropdown = document.getElementById('manageEventDropdown');
        const deleteEventButton = document.getElementById('deleteEventButton');
        const doneManageEventsButton = document.getElementById('doneManageEventsButton');

        const eventTilesContainer = document.getElementById('eventTilesContainer');
        const noEventsToShowMessage = document.getElementById('noEventsToShowMessage');
        
        const eventSpecificBanner = document.getElementById('eventSpecificBanner');
        const eventSpecificTitle = document.getElementById('eventSpecificTitle');
        const backToEventSelectionButton = document.getElementById('backToEventSelectionButton');

        const userNameInput = document.getElementById('userNameInput');
        const enterAppButton = document.getElementById('enterAppButton');
        const searchInput = document.getElementById('searchInput');
        const filterButton = document.getElementById('filterButton');
        const metricsButton = document.getElementById('metricsButton');
        const attendeesTableBody = document.getElementById('attendeesTableBody');
        const noAttendeesMessage = document.getElementById('noAttendeesMessage');
        const homeScreenTotalAttendeesCount = document.getElementById('homeScreenTotalAttendeesCount');
        const eventStatusIndicator = document.getElementById('eventStatusIndicator'); 
        const attendeeStatusDisplay = document.getElementById('attendeeStatusDisplay'); 
        
        const attendeeModal = document.getElementById('attendeeModal');
        const attendeeModalContent = document.getElementById('attendeeModalContent');
        const modalBody = document.getElementById('modalBody');
        const closeAttendeeModalButton = document.getElementById('closeAttendeeModalButton');
        const closeAttendeeModalFooterButton = document.getElementById('closeAttendeeModalFooterButton');
        const demoRequestedButton = document.getElementById('demoRequestedButton');
        const demoRequestedButtonText = document.getElementById('demoRequestedButtonText');
        const demoRequestedCheckmark = document.getElementById('demoRequestedCheckmark');

        const generateIcebreakerButton = document.getElementById('generateIcebreakerButton');
        const icebreakerResult = document.getElementById('icebreakerResult');
        const icebreakerSpinner = document.getElementById('icebreakerSpinner');

        const filterModal = document.getElementById('filterModal');
        const closeFilterModalButton = document.getElementById('closeFilterModalButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const filterType = document.getElementById('filterType');
        const filterFocusAccount = document.getElementById('filterFocusAccount');
        const filterAE = document.getElementById('filterAE'); 
        const filterSDR = document.getElementById('filterSDR'); 

        const metricsModal = document.getElementById('metricsModal');
        const closeMetricsModalButton = document.getElementById('closeMetricsModalButton');
        const closeMetricsModalFooterButton = document.getElementById('closeMetricsModalFooterButton');
        const totalAttendeesCountEl = document.getElementById('totalAttendeesCount');
        const sdrChartCanvas = document.getElementById('sdrChart');
        const aeChartCanvas = document.getElementById('aeChart');
        const attendeeTypeChartCanvas = document.getElementById('attendeeTypeChart');

        const demoRequestsTableBody = document.getElementById('demoRequestsTableBody');
        const noDemoRequestsMessage = document.getElementById('noDemoRequestsMessage');
        const downloadDemoRequestsCsvButton = document.getElementById('downloadDemoRequestsCsvButton');

        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryFetchButton = document.getElementById('retryFetchButton');
        const attendeesTableContainer = document.getElementById('attendeesTableContainer');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmTitle = document.getElementById('customConfirmTitle');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmOkButton = document.getElementById('customConfirmOkButton');
        const customConfirmCancelButton = document.getElementById('customConfirmCancelButton');
        let confirmCallback = null;
        const notificationToast = document.getElementById('notificationToast');


        // Global State
        let allAttendees = [];
        let currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' }; 
        let currentSearchTerm = '';
        let currentAttendeeForDemo = null;
        let currentUserNameFromStorage = '';
        let currentSelectedEventId = null;
        let currentSelectedEventData = null; 
        let pollingTimeoutId = null;


        let sdrChartInstance = null;
        let aeChartInstance = null;
        let attendeeTypeChartInstance = null;

        // Firebase
        let db;
        let auth;
        let currentUserId; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyCRGbSyg71HdQf-zMrjT9Vz9iaCU3cKOPw", 
            authDomain: "attendeetrackerapp.firebaseapp.com", 
            projectId: "attendeetrackerapp", 
            storageBucket: "attendeetrackerapp.appspot.com", 
            messagingSenderId: "301064425215", 
            appId: "1:301064425215:web:17fd2b66cd2e47d9b0c6ca" 
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendee-app'; 
        setLogLevel('debug'); 

        // CSV Header Mapping
        const headerMapping = {
            'First Name': 'firstName', 'Last Name': 'lastName', 'Email': 'email', 'Phone': 'phone',
            'Company': 'company', 'Job Title': 'jobTitle', 'Type': 'type', 
            'Focus Account': 'focusAccount', 'On-ground AE': 'onGroundAE', 'On-ground SDR': 'onGroundSDR',
            'Notes': 'notes', 
            'LinkedIn': 'linkedin', 
            'Recently Migrated logos': 'recentlyMigratedLogos'
        };
        const expectedHeaders = Object.keys(headerMapping);

        const adminUsers = {
            "Venkat": "venkata24", "Shitij": "shitija25", "Sandeep": "sandeepa23", 
            "Priya": "priyaa26", "Sravan": "sravana27", "Ashik": "ashika28", "Rohit": "rohita29", "Arti": "artia30"
        };

        // --- Screen Management ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            [addEventModal, manageEventsModal, attendeeModal, filterModal, metricsModal, customConfirmModal].forEach(modal => modal.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }
        
        // --- Custom Confirm Modal ---
        function showCustomConfirm(title, message, callback) {
            customConfirmTitle.textContent = title;
            customConfirmMessage.textContent = message;
            confirmCallback = callback;
            customConfirmModal.classList.remove('hidden');
        }
        customConfirmOkButton.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true);
            customConfirmModal.classList.add('hidden');
        });
        customConfirmCancelButton.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false);
            customConfirmModal.classList.add('hidden');
        });
        customConfirmModal.addEventListener('click', (e) => { 
            if (e.target === customConfirmModal) {
                if (confirmCallback) confirmCallback(false);
                customConfirmModal.classList.add('hidden');
            }
        });
        
        // --- Notification System ---
        function showNotification(message, type = 'info') { // types: 'success', 'error', 'info'
            notificationToast.textContent = message;
            notificationToast.className = ''; // Clear existing classes
            notificationToast.classList.add('show');
            if (type === 'success') notificationToast.classList.add('bg-success');
            else if (type === 'error') notificationToast.classList.add('bg-error');
            else notificationToast.classList.add('bg-info');
            
            setTimeout(() => {
                notificationToast.classList.remove('show');
            }, 3000);
        }


        // Chart.js Custom Plugin for Data Labels
        Chart.register({
            id: 'customDataLabelsOnTop',
            afterDatasetsDraw: (chart, args, options) => {
                const { ctx, data, _metasets } = chart;
                ctx.save();
                ctx.font = options.font || '12px Arial';
                ctx.fillStyle = options.color || 'black';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                for (let i = 0; i < data.datasets.length; i++) {
                    const dataset = data.datasets[i];
                    const meta = _metasets[i];
                    if (meta.hidden) continue;

                    for (let j = 0; j < meta.data.length; j++) {
                        const element = meta.data[j];
                        const value = dataset.data[j];
                        if (value !== null && value !== undefined) {
                              ctx.fillText(value.toString(), element.x, element.y - (options.padding || 5));
                        }
                    }
                }
                ctx.restore();
            }
        });

        // CSV Parsing Functions (Revised for better newline handling)
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            csvText = csvText.trim();

            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];

                if (char === '"') {
                    if (inQuotes && i + 1 < csvText.length && csvText[i+1] === '"') {
                        currentField += '"'; i++; 
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField); 
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (csvText[i+1] === '\n' && char === '\r') { i++; }
                    currentRow.push(currentField);
                    rows.push(currentRow.map(f => f.trim())); 
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            currentRow.push(currentField); 
            if (currentRow.length > 0 && (currentRow.length > 1 || currentRow[0].trim() !== '')) { 
                 rows.push(currentRow.map(f => f.trim())); 
            }
            
            if (rows.length === 0) return [];

            const rawHeaders = rows[0];
            const data = [];
            const actualHeaders = rawHeaders.map(h => String(h).trim());


            const coreExpectedHeaders = Object.keys(headerMapping);
            const missingCoreHeaders = coreExpectedHeaders.filter(eh => !actualHeaders.includes(eh));
            if (missingCoreHeaders.length > 0) {
                console.warn('Core CSV headers missing/mismatched. Expected:', missingCoreHeaders, 'Actual:', actualHeaders);
            }

            for (let i = 1; i < rows.length; i++) {
                const values = rows[i];
                const entry = {};
                let isEmptyRow = true;
                const numVals = Math.min(values.length, actualHeaders.length);
                for (let j = 0; j < numVals; j++) {
                    const header = actualHeaders[j]; 
                    const mappedKey = headerMapping[header] || header.toLowerCase().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    entry[mappedKey] = values[j] || ''; 
                    if (values[j] && String(values[j]).trim() !== '') isEmptyRow = false;
                }
                if (!isEmptyRow || Object.keys(entry).some(k => entry[k])) { 
                     data.push(entry);
                }
            }
            return data;
        }


        // Populate Filter Dropdowns
        function populateFilterDropdowns(attendees) {
            const uniqueAEs = new Set(); const uniqueSDRs = new Set();
            attendees.forEach(att => {
                if (att.onGroundAE && att.onGroundAE.trim() !== '') uniqueAEs.add(att.onGroundAE.trim());
                if (att.onGroundSDR && att.onGroundSDR.trim() !== '') uniqueSDRs.add(att.onGroundSDR.trim());
            });
            filterAE.innerHTML = '<option value="All">All AEs</option>'; 
            Array.from(uniqueAEs).sort().forEach(ae => { const opt = document.createElement('option'); opt.value = ae; opt.textContent = ae; filterAE.appendChild(opt); });
            filterSDR.innerHTML = '<option value="All">All SDRs</option>'; 
            Array.from(uniqueSDRs).sort().forEach(sdr => { const opt = document.createElement('option'); opt.value = sdr; opt.textContent = sdr; filterSDR.appendChild(opt); });
        }

        // Firestore ID Sanitization
        function sanitizeForFirestoreId(id) {
            if (!id) return `unknown_id_${crypto.randomUUID()}`; 
            return id.replace(/[^a-zA-Z0-9_.-]/g, '_');
        }
        
        // Update Event Status Indicator
        function updateEventStatusIndicator() {
            if (!currentSelectedEventData || !currentSelectedEventData.eventDate || !currentSelectedEventData.eventStartTime || !currentSelectedEventData.eventEndTime) {
                eventStatusIndicator.classList.add('hidden');
                return;
            }
            const now = new Date();
            const eventStartDateTimeStr = `${currentSelectedEventData.eventDate}T${currentSelectedEventData.eventStartTime}:00`;
            const eventEndDateTimeStr = `${currentSelectedEventData.eventDate}T${currentSelectedEventData.eventEndTime}:00`;
            
            let eventStartDate, eventEndDate;
            try {
                eventStartDate = new Date(eventStartDateTimeStr);
                eventEndDate = new Date(eventEndDateTimeStr);
                if (isNaN(eventStartDate.getTime()) || isNaN(eventEndDate.getTime())) {
                    throw new Error("Invalid date/time format for event.");
                }
            } catch (e) {
                console.error("Error parsing event date/time:", e, currentSelectedEventData);
                eventStatusIndicator.classList.add('hidden');
                return;
            }

            attendeeStatusDisplay.style.backgroundColor = ''; 
            eventStatusIndicator.classList.add('hidden'); 

            if (now < eventStartDate) {
                eventStatusIndicator.style.backgroundColor = 'red';
                eventStatusIndicator.classList.remove('hidden');
            } else if (now >= eventStartDate && now <= eventEndDate) {
                eventStatusIndicator.style.backgroundColor = '#0abc58'; // Green
                eventStatusIndicator.classList.remove('hidden');
            }
        }


        // Fetch Attendees Data
        async function fetchAttendees() {
            if (!CURRENT_EVENT_GOOGLE_SHEET_URL) {
                console.warn("No event selected or source sheet URL is missing.");
                showError(true, "No event selected or data source missing.");
                return;
            }
            showLoading(true); showError(false); let fetchSucceeded = false;
            try {
                const response = await fetch(CURRENT_EVENT_GOOGLE_SHEET_URL + `&t=${new Date().getTime()}`); 
                if (!response.ok) {
                    let errMsg = `HTTP error! Status: ${response.status}.`;
                    throw new Error(errMsg);
                }
                const csvText = await response.text();
                let parsedAtt = (csvText.trim() === '') ? [] : parseCSV(csvText);
                                
                const attendeesWithDemoStatus = await Promise.all(parsedAtt.map(async (attendee) => {
                    let demoRequested = false;
                    let demoRequestedBy = '';
                    if (db && currentUserId && attendee.email && currentSelectedEventId) {
                        const safeEmailId = sanitizeForFirestoreId(attendee.email);
                        const demoStatusRef = doc(db, "artifacts", appId, "public/data/eventDemoStatus", currentSelectedEventId, "attendees", safeEmailId);
                        try {
                            const docSnap = await getDoc(demoStatusRef);
                            if (docSnap.exists()) {
                                demoRequested = docSnap.data().requested === true;
                                demoRequestedBy = docSnap.data().requestedBy || '';
                            }
                        } catch (fsError) {
                            console.error("Error fetching demo status for", attendee.email, fsError);
                        }
                    }
                    return { ...attendee, demoRequested, demoRequestedBy };
                }));

                allAttendees = attendeesWithDemoStatus.filter(att => (att.firstName && att.firstName.trim() !== '') || (att.lastName && att.lastName.trim() !== '') || (att.company && att.company.trim() !== '') || (att.jobTitle && att.jobTitle.trim() !== '') );
                                
                homeScreenTotalAttendeesCount.textContent = allAttendees.length;
                updateEventStatusIndicator(); 
                                
                populateFilterDropdowns(allAttendees); 
                fetchSucceeded = true;
            } catch (error) {
                 console.error('Error fetching attendees:', error);
                let userFriendlyMessage = `Failed to load attendee data: ${error.message}.`;
                if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                    userFriendlyMessage = 'Failed to fetch attendee data. This could be a network issue, or the Google Sheet URL might be temporarily inaccessible or blocked. Please check your internet connection and ensure the Google Sheet is correctly published and publicly accessible via its CSV link. Try refreshing the page.';
                }
                showError(true, userFriendlyMessage);
            } finally {
                 showLoading(false); 
                 if (fetchSucceeded) {
                    applyFiltersAndSearch(); 
                 }
            }
        }

        // UI Helper Functions
        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            attendeesTableContainer.classList.toggle('hidden', isLoading);
            noAttendeesMessage.classList.toggle('hidden', isLoading); 
        }
        function showError(show, message = '') {
            errorText.textContent = message; errorMessage.classList.toggle('hidden', !show);
            attendeesTableContainer.classList.toggle('hidden', show); 
            noAttendeesMessage.classList.toggle('hidden', show); 
        }

        // Render Table
        function renderTable(attendeesToRender) {
            attendeesTableBody.innerHTML = ''; 
            const tableHeader = attendeesTableContainer.querySelector('table thead');
            if (attendeesToRender.length === 0) { noAttendeesMessage.classList.remove('hidden'); tableHeader.classList.add('hidden'); } 
            else {
                noAttendeesMessage.classList.add('hidden'); tableHeader.classList.remove('hidden'); 
                attendeesToRender.forEach((attendee, index) => {
                    const row = attendeesTableBody.insertRow();
                    row.className = 'hover:bg-gray-100 cursor-pointer transition-colors no-select';
                    if (attendee.demoRequested) { 
                        row.classList.add('demo-requested-row-active');
                    }

                    const originalAttendeeRef = allAttendees.find(orig => orig.email === attendee.email && orig.firstName === attendee.firstName && orig.lastName === attendee.lastName);
                    const dataId = originalAttendeeRef ? allAttendees.indexOf(originalAttendeeRef) : index; 
                    row.setAttribute('data-id', dataId); 
                    const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
                    const cellName = row.insertCell();
                    const cellCompany = row.insertCell();
                    const cellTitle = row.insertCell();

                    cellName.textContent = fullName || 'N/A';
                    cellCompany.textContent = attendee.company || 'N/A';
                    cellTitle.textContent = attendee.jobTitle || 'N/A';

                    Array.from(row.cells).forEach(cell => {
                        cell.className = 'px-6 py-4 text-sm text-gray-700 break-words';
                    });
                                        
                    row.addEventListener('click', () => openAttendeeDetailModal(attendee));
                });
            }
        }
        
        // Clipboard Helper
        function copyToClipboard(text, feedbackElement) {
            const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); if(feedbackElement) { feedbackElement.textContent = 'Copied!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            catch (err) { console.error('Copy failed: ', err); if(feedbackElement) { feedbackElement.textContent = 'Copy failed!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            document.body.removeChild(ta);
        }

        // Update Demo Requested Button UI
        function updateDemoRequestedButtonUI(isRequested) {
            if (isRequested) {
                demoRequestedButtonText.textContent = 'Requested';
                demoRequestedCheckmark.classList.remove('hidden');
                demoRequestedButton.classList.add('bg-gray-300', 'hover:bg-gray-300', 'text-gray-500'); 
                demoRequestedButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                attendeeModalContent.classList.add('demo-requested-active');
            } else {
                demoRequestedButtonText.textContent = 'Demo Requested';
                demoRequestedCheckmark.classList.add('hidden');
                demoRequestedButton.classList.remove('bg-gray-300', 'hover:bg-gray-300', 'text-gray-500');
                demoRequestedButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
                attendeeModalContent.classList.remove('demo-requested-active');
            }
        }

        // Attendee Detail Modal Logic
        function openAttendeeDetailModal(attendee) {
            currentAttendeeForDemo = attendee; 
            modalBody.innerHTML = ''; 
            icebreakerResult.textContent = '';
            icebreakerResult.classList.add('hidden');
            const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
            
            const createDetailRow = (label, value, type = 'text', isLink = false, linkTarget = '_blank') => {
                if (value && String(value).trim() !== '') { 
                    const div = document.createElement('div'); div.className = 'grid grid-cols-3 gap-2 items-center';
                    const lbl = document.createElement('p'); lbl.className = 'text-sm font-medium text-gray-500 col-span-1 break-words'; lbl.textContent = label + ':'; div.appendChild(lbl);
                    const valCont = document.createElement('div'); valCont.className = 'text-sm text-gray-900 col-span-2 break-words flex items-center';
                    
                    if (isLink) {
                        const a = document.createElement('a');
                        let hrefValue = String(value);
                        if (!hrefValue.match(/^https?:\/\//i) && hrefValue.includes('.')) { 
                            hrefValue = 'https://' + hrefValue;
                        }
                        a.href = hrefValue;
                        a.textContent = value; 
                        a.className = 'text-blue-600 hover:text-blue-800 hover:underline';
                        if (linkTarget) {
                            a.target = linkTarget;
                            a.rel = 'noopener noreferrer'; 
                        }
                        valCont.appendChild(a);
                    } else if (type === 'tel' && value) { 
                        const a = document.createElement('a'); a.href = `tel:${String(value).replace(/\s+/g, '')}`; a.textContent = value; a.className = 'text-blue-600 hover:text-blue-800 hover:underline'; valCont.appendChild(a); 
                    } else if (type === 'email' && value) {
                        const emSpan = document.createElement('span'); emSpan.textContent = value; emSpan.className = 'text-blue-600 hover:text-blue-800 hover:underline cursor-pointer';
                        const fbSpan = document.createElement('span'); fbSpan.className = 'copy-feedback';
                        emSpan.addEventListener('click', () => copyToClipboard(value, fbSpan));
                        valCont.appendChild(emSpan); valCont.appendChild(fbSpan);
                    } else { 
                        const p = document.createElement('p'); p.innerHTML = String(value).replace(/\n/g, '<br>'); valCont.appendChild(p); 
                    } 
                    div.appendChild(valCont); modalBody.appendChild(div);
                }
            };
            createDetailRow('Full Name', fullName); 
            createDetailRow('Company', attendee.company); 
            createDetailRow('Job Title', attendee.jobTitle); 
            createDetailRow('Type', attendee.type);
            createDetailRow('Focus Account', attendee.focusAccount); 
            createDetailRow('On-ground AE', attendee.onGroundAE); 
            createDetailRow('On-ground SDR', attendee.onGroundSDR);
            if (attendee.linkedin) { 
                 createDetailRow('LinkedIn', attendee.linkedin, 'text', true);
            }
            createDetailRow('Recently Migrated logos', attendee.recentlyMigratedLogos);
            createDetailRow('Notes', attendee.notes);
            createDetailRow('Phone', attendee.phone, 'tel');
            createDetailRow('Email', attendee.email, 'email'); 
                                    
            updateDemoRequestedButtonUI(attendee.demoRequested === true);
            attendeeModal.classList.remove('hidden');
        }
        function closeAttendeeDetailModal() { 
            attendeeModal.classList.add('hidden');
            currentAttendeeForDemo = null; 
            attendeeModalContent.classList.remove('demo-requested-active');
        }

        // Filter Modal Logic
        function openFilterModal() {
            filterType.value = currentFilters.type; 
            filterFocusAccount.value = currentFilters.focusAccount;
            filterAE.value = currentFilters.onGroundAE; 
            filterSDR.value = currentFilters.onGroundSDR; 
            filterModal.classList.remove('hidden');
        }
        function closeFilterModal() { filterModal.classList.add('hidden'); }

        // Charting Functions
        function createOrUpdateChart(chartInstance, canvasElement, chartType, data, options) {
            if (chartInstance) { chartInstance.destroy(); }
            return new Chart(canvasElement, { type: chartType, data: data, options: options });
        }

        function openMetricsModal() {
            totalAttendeesCountEl.textContent = allAttendees.length; 
            const sdrCounts = {}; const aeCounts = {}; const typeCounts = { 'Prospect': 0, 'Partner': 0, 'Customer': 0 };
            const demoRequestedAttendees = [];

            allAttendees.forEach(attendee => {
                const sdrFullName = attendee.onGroundSDR?.trim();
                if (sdrFullName) {
                    const sdrFirstName = sdrFullName.split(' ')[0]; 
                    sdrCounts[sdrFirstName] = (sdrCounts[sdrFirstName] || 0) + 1;
                }

                const aeFullName = attendee.onGroundAE?.trim();
                if (aeFullName) {
                    const aeFirstName = aeFullName.split(' ')[0]; 
                    aeCounts[aeFirstName] = (aeCounts[aeFirstName] || 0) + 1;
                }
                
                const type = attendee.type?.trim();
                if (type && typeCounts.hasOwnProperty(type)) typeCounts[type]++;
                
                if (attendee.demoRequested === true) { 
                    demoRequestedAttendees.push(attendee);
                }
            });

            const chartOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        display: false, 
                        beginAtZero: true,
                        grace: '10%' 
                    },
                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                }, 
                plugins: { 
                    legend: { display: false },
                    customDataLabelsOnTop: { color: '#333', font: 'bold 12px Arial', padding: 6 }
                }, 
                animation: false 
            };
                        
            const sdrChartData = { labels: Object.keys(sdrCounts), datasets: [{ label: 'Attendees by SDR', data: Object.values(sdrCounts), backgroundColor: '#0abd57', borderColor: '#0abd57', borderWidth: 1 }] };
            sdrChartInstance = createOrUpdateChart(sdrChartInstance, sdrChartCanvas, 'bar', sdrChartData, chartOptions);

            const aeChartData = { labels: Object.keys(aeCounts), datasets: [{ label: 'Attendees by AE', data: Object.values(aeCounts), backgroundColor: '#17494c', borderColor: '#17494c', borderWidth: 1 }] };
            aeChartInstance = createOrUpdateChart(aeChartInstance, aeChartCanvas, 'bar', aeChartData, chartOptions);
                        
            const attendeeTypeChartData = { labels: Object.keys(typeCounts), datasets: [{ label: 'Attendees by Type', data: Object.values(typeCounts), backgroundColor: ['#0abd57', '#17494c', '#000000'], borderColor: ['#0abd57', '#17494c', '#000000'], borderWidth: 1 }] };
            attendeeTypeChartInstance = createOrUpdateChart(attendeeTypeChartInstance, attendeeTypeChartCanvas, 'bar', attendeeTypeChartData, chartOptions);

            demoRequestsTableBody.innerHTML = '';
            if (demoRequestedAttendees.length > 0) {
                noDemoRequestsMessage.classList.add('hidden');
                demoRequestsTableContainer.querySelector('table thead').classList.remove('hidden');
                demoRequestedAttendees.forEach(attendee => {
                    const row = demoRequestsTableBody.insertRow();
                    const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
                    row.insertCell().textContent = fullName || 'N/A';
                    row.insertCell().textContent = attendee.company || 'N/A';
                    row.insertCell().textContent = attendee.jobTitle || 'N/A';
                    row.insertCell().textContent = attendee.demoRequestedBy || 'N/A'; 
                    Array.from(row.cells).forEach(cell => cell.className = 'px-6 py-3 whitespace-nowrap text-sm text-gray-700');
                });
            } else {
                noDemoRequestsMessage.classList.remove('hidden');
                demoRequestsTableContainer.querySelector('table thead').classList.add('hidden');
            }

            metricsModal.classList.remove('hidden');
        }
        function closeMetricsModal() { metricsModal.classList.add('hidden'); }

        // Apply Filters and Search
        function applyFiltersAndSearch() {
            let filtered = [...allAttendees]; 
            filtered = filtered.filter(att => 
                (currentFilters.type === 'All' || (att.type && att.type.toLowerCase() === currentFilters.type.toLowerCase())) &&
                (currentFilters.focusAccount === 'All' || (att.focusAccount && att.focusAccount.toLowerCase() === currentFilters.focusAccount.toLowerCase())) &&
                (currentFilters.onGroundAE === 'All' || (att.onGroundAE && att.onGroundAE === currentFilters.onGroundAE)) && 
                (currentFilters.onGroundSDR === 'All' || (att.onGroundSDR && att.onGroundSDR === currentFilters.onGroundSDR))
               );
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(att =>
                    (`${att.firstName || ''} ${att.lastName || ''}`.toLowerCase().includes(searchTermLower)) ||
                    ((att.company || '').toLowerCase().includes(searchTermLower)) ||
                    ((att.jobTitle || '').toLowerCase().includes(searchTermLower))
                );
            } 
            filtered.reverse(); 

            if (!loadingSpinner.classList.contains('hidden') || !errorMessage.classList.contains('hidden')) {} 
            else { attendeesTableContainer.classList.remove('hidden'); renderTable(filtered); }
        }

        // User Name Persistence (Firestore & localStorage)
        async function saveUserName(name) {
            currentUserNameFromStorage = name; 
            localStorage.setItem('attendeeAppUserName', name); 
            if (!db || !currentUserId) {
                console.warn("Firestore not initialized or user ID not available for saving name. Name not saved to cloud.");
                return;
            }
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId, "userData", "profile");
            try {
                await setDoc(userDocRef, { firstName: name }, { merge: true });
                console.log("User name saved to Firestore for user:", currentUserId);
            } catch (error) {
                console.error("Error saving user name to Firestore:", error);
            }
        }
                
        async function getUserNameFromFirestoreOrLocalStorage() {
            let name = localStorage.getItem('attendeeAppUserName');
            if (name) return name;

            if (!db || !currentUserId) {
                console.warn("Firestore not initialized or user ID not available for getting name.");
                return null;
            }
            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId, "userData", "profile");
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    name = docSnap.data().firstName;
                    if (name) localStorage.setItem('attendeeAppUserName', name); 
                    return name;
                }
                return null;
            } catch (error) {
                console.error("Error getting user name from Firestore:", error);
                return null;
            }
        }

        // Demo Request Logic (Firestore)
        async function toggleDemoRequest(attendee) {
            if (!db || !currentUserId || !attendee || !attendee.email || !currentSelectedEventId) {
                console.error("toggleDemoRequest PRE-CONDITION FAILED (Event ID missing or other):", currentSelectedEventId);
                showNotification("Could not update demo request. Critical information missing.", "error");
                return;
            }
            const safeEmailId = sanitizeForFirestoreId(attendee.email);
            const demoStatusRef = doc(db, "artifacts", appId, "public/data/eventDemoStatus", currentSelectedEventId, "attendees", safeEmailId); 
            const newDemoStatus = !(attendee.demoRequested === true); 

            try {
                if (newDemoStatus) {
                    await setDoc(demoStatusRef, { 
                        requested: true, 
                        requestedBy: currentUserNameFromStorage || "Unknown User",
                        requestedByUserId: currentUserId, 
                        timestamp: new Date().toISOString() 
                    });
                } else {
                    await deleteDoc(demoStatusRef); 
                }
                                
                const attendeeInGlobalArray = allAttendees.find(a => a.email === attendee.email);
                if (attendeeInGlobalArray) {
                    attendeeInGlobalArray.demoRequested = newDemoStatus;
                    attendeeInGlobalArray.demoRequestedBy = newDemoStatus ? (currentUserNameFromStorage || "Unknown User") : '';
                } else { 
                    attendee.demoRequested = newDemoStatus; 
                    attendee.demoRequestedBy = newDemoStatus ? (currentUserNameFromStorage || "Unknown User") : '';
                }
                                
                updateDemoRequestedButtonUI(newDemoStatus);
                console.log(`Demo request for ${attendee.email} (Event: ${currentSelectedEventId}) set to ${newDemoStatus} by ${currentUserNameFromStorage}`);
                                
                applyFiltersAndSearch(); 
                if (!metricsModal.classList.contains('hidden')) {
                    openMetricsModal();
                }

            } catch (error) {
                console.error("Error updating demo request status in Firestore:", error);
                showNotification(`Failed to update demo request status: ${error.message}.`, "error");
            }
        }

        // CSV Download Function
        function downloadCSV(data, filename = 'demo-requests.csv') {
            const csvHeader = "First Name,Last Name,Company,Job Title,Email Address,Phone,Type,Focus Account,On-ground SDR,On-ground AE,LinkedIn,Recently Migrated logos,Demo Requested By\n"; 
            const csvRows = data.map(row => {
                return [
                    `"${(row.firstName || '').replace(/"/g, '""')}"`,
                    `"${(row.lastName || '').replace(/"/g, '""')}"`,
                    `"${(row.company || '').replace(/"/g, '""')}"`,
                    `"${(row.jobTitle || '').replace(/"/g, '""')}"`,
                    `"${(row.email || '').replace(/"/g, '""')}"`,
                    `"${(row.phone || '').replace(/"/g, '""')}"`,
                    `"${(row.type || '').replace(/"/g, '""')}"`,
                    `"${(row.focusAccount || '').replace(/"/g, '""')}"`,
                    `"${(row.onGroundSDR || '').replace(/"/g, '""')}"`,
                    `"${(row.onGroundAE || '').replace(/"/g, '""')}"`,
                    `"${(row.linkedin || '').replace(/"/g, '""')}"`, 
                    `"${(row.recentlyMigratedLogos || '').replace(/"/g, '""')}"`,
                    `"${(row.demoRequestedBy || '').replace(/"/g, '""')}"`
                ].join(',');
            }).join('\n');

            const csvString = csvHeader + csvRows;
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- Event Management Functions ---
        async function saveEventProfile(eventData) {
            if (!db) { console.error("Firestore not initialized."); return false; }
            const eventId = sanitizeForFirestoreId(eventData.eventName.toLowerCase().replace(/\s+/g, '-')) + '-' + Date.now(); 
            const eventRef = doc(db, "artifacts", appId, "public/data/eventProfiles", eventId);
            try {
                await setDoc(eventRef, { ...eventData, id: eventId, createdAt: new Date().toISOString() });
                console.log("Event profile saved:", eventId);
                return true;
            } catch (error) {
                console.error("Error saving event profile:", error);
                return false;
            }
        }

        async function fetchEventProfiles() {
            if (!db) { console.error("Firestore not initialized."); return []; }
            const eventsCol = collection(db, "artifacts", appId, "public/data/eventProfiles");
            try {
                const snapshot = await getDocs(eventsCol);
                const events = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                return events.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 
            } catch (error) {
                console.error("Error fetching event profiles:", error);
                return [];
            }
        }
        
        async function deleteEventProfile(eventId) {
            if (!db) { console.error("Firestore not initialized."); return false; }
            
            showCustomConfirm("Delete Event", `Are you sure you want to delete this event and all its associated data (like demo requests)? This action cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    deleteEventButton.disabled = true;
                    deleteEventButton.textContent = 'Deleting...';
                    try {
                        const batch = writeBatch(db);
                        const eventRef = doc(db, "artifacts", appId, "public/data/eventProfiles", eventId);
                        batch.delete(eventRef);

                        const demoRequestsPath = `artifacts/${appId}/public/data/eventDemoStatus/${eventId}/attendees`;
                        const demoRequestsCol = collection(db, demoRequestsPath);
                        const demoRequestsSnapshot = await getDocs(demoRequestsCol);
                        demoRequestsSnapshot.forEach(docSnap => {
                            batch.delete(docSnap.ref);
                        });
                        
                        await batch.commit();
                        console.log("Event profile and associated data deleted:", eventId);
                        await populateManageEventsDropdown(); 
                        await populateEventTiles(); 
                        showNotification("Event deleted successfully.", "success"); 
                    } catch (error) {
                        console.error("Error deleting event profile:", error);
                        showNotification("Failed to delete event. Check console for details.", "error"); 
                    } finally {
                        deleteEventButton.disabled = false;
                        deleteEventButton.textContent = 'Delete Selected Event';
                    }
                }
            });
        }


        async function populateManageEventsDropdown() {
            const events = await fetchEventProfiles();
            manageEventDropdown.innerHTML = '<option value="">-- Select Event --</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.eventName;
                manageEventDropdown.appendChild(option);
            });
        }
        
        async function populateEventTiles() {
            const events = await fetchEventProfiles();
            eventTilesContainer.innerHTML = ''; 
            if (events.length === 0) {
                noEventsToShowMessage.classList.remove('hidden');
                return;
            }
            noEventsToShowMessage.classList.add('hidden');

            events.forEach(event => {
                const tile = document.createElement('div');
                tile.className = 'grid-tile';
                tile.dataset.eventId = event.id;

                const img = document.createElement('img');
                img.src = event.eventBannerUrl || 'https://placehold.co/300x100/cccccc/333333?text=No+Banner';
                img.alt = event.eventName;
                img.onerror = function() { this.src='https://placehold.co/300x100/cccccc/333333?text=Banner+Error'; };
                
                const name = document.createElement('h3');
                name.className = 'text-lg font-semibold text-gray-800 mt-2';
                name.textContent = event.eventName;

                const dateText = event.eventDate ? new Date(event.eventDate + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'Date TBD';
                const date = document.createElement('p');
                date.className = 'text-xs text-gray-500';
                date.textContent = dateText;


                tile.appendChild(img);
                tile.appendChild(name);
                tile.appendChild(date);
                
                tile.addEventListener('click', () => loadEventSpecificView(event));
                eventTilesContainer.appendChild(tile);
            });
        }

        function loadEventSpecificView(eventData) {
            currentSelectedEventId = eventData.id;
            currentSelectedEventData = eventData; 
            CURRENT_EVENT_GOOGLE_SHEET_URL = eventData.eventSheetUrl;
            eventSpecificBanner.src = eventData.eventBannerUrl || 'https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';
            eventSpecificTitle.textContent = eventData.eventName;
            
            allAttendees = []; 
            if(pollingTimeoutId) clearTimeout(pollingTimeoutId); 
            
            currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
            currentSearchTerm = '';
            searchInput.value = '';


            showScreen('mainApp');
            fetchAttendees(); 
            pollingTimeoutId = setTimeout(fetchAttendees, POLLING_INTERVAL);
        }

        // --- Gemini API Function ---
        async function generateIcebreaker(attendee) {
            icebreakerResult.classList.add('hidden');
            icebreakerSpinner.classList.remove('hidden');
            generateIcebreakerButton.disabled = true;

            const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
            let prompt = `Generate a short, professional, and friendly icebreaker (1-2 sentences) to start a conversation with ${fullName}.`;
            if(attendee.jobTitle) prompt += ` They are a ${attendee.jobTitle}`;
            if(attendee.company) prompt += ` at ${attendee.company}.`;
            if(attendee.notes) prompt += ` Some notes about them: "${attendee.notes}".`;
            if(attendee.recentlyMigratedLogos) prompt += ` They recently migrated from these technologies: ${attendee.recentlyMigratedLogos}.`;
            prompt += ` The conversation is happening at the "${currentSelectedEventData.eventName || 'event'}".`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // This will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    icebreakerResult.textContent = text.replace(/[*_]/g, ''); // Remove markdown
                    icebreakerResult.classList.remove('hidden');
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                icebreakerResult.textContent = "Sorry, couldn't generate an icebreaker at this time.";
                icebreakerResult.classList.remove('hidden');
                showNotification("Error generating icebreaker.", "error");
            } finally {
                icebreakerSpinner.classList.add('hidden');
                generateIcebreakerButton.disabled = false;
            }
        }


        // --- App Initialization ---
        async function initializeAppLogic() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                   try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } catch (customTokenError) {
                        console.warn("Custom token sign-in failed:", customTokenError.code, customTokenError.message, ". Falling back to anonymous sign-in.");
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously after custom token failure.");
                    }
                } else {
                    console.log("Attempting to sign in anonymously (no custom token provided)...");
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                currentUserId = auth.currentUser?.uid; 
                if (!currentUserId) { 
                    console.warn("Firebase User ID not available after sign-in attempt. Using a temporary local ID.");
                    currentUserId = `local-${crypto.randomUUID()}`;
                }
                console.log("Firebase Initialized. User ID for this session:", currentUserId);
                currentUserNameFromStorage = await getUserNameFromFirestoreOrLocalStorage(); 
            } catch (error) {
                console.error("Critical Error during Firebase initialization or Auth:", error);
                showNotification("Could not connect to essential services. App functionality will be limited.", "error");
                db = null; auth = null; currentUserId = `local-${crypto.randomUUID()}`; 
            }

            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showScreen('adminControls');
            } else if (currentUserNameFromStorage) {
                welcomeBackMessage.textContent = `Welcome back, ${currentUserNameFromStorage}!`;
                userNamePrompt.classList.add('hidden');
                returningUserOptions.classList.remove('hidden');
                showScreen('welcome');
            } else {
                userNamePrompt.classList.remove('hidden');
                returningUserOptions.classList.add('hidden');
                showScreen('welcome');
            }
            updateEventStatusIndicator(); 

            adminUsernameSelect.innerHTML = ''; 
            Object.keys(adminUsers).forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                adminUsernameSelect.appendChild(option);
            });
            
             if (db) { 
                const initialEvents = [
                    { eventName: "#GROWTH Summit Mumbai 2025", city: "Mumbai", eventDate: "2025-05-28", eventStartTime: "09:30", eventEndTime: "22:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv", eventBannerUrl: "https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" },
                    { eventName: "#GROWTH Summit Dubai 2025", city: "Dubai", eventDate: "2025-11-12", eventStartTime: "16:00", eventEndTime: "22:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv", eventBannerUrl: "https://2369873.fs1.hubspotusercontent-na1.net/hubfs/2369873/Growth%20Summit%20logo.png" },
                    { eventName: "Customer Engagement Summit 2025", city: "New York", eventDate: "2025-09-24", eventStartTime: "09:00", eventEndTime: "19:00", eventSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCr4DyPsk-XWPtgbSj9Ren9mZ0MU91KSJ-PES8JeFc2EYMo272N3Yv14NGvCWEWcaGfATcqPXWGz9g/pub?gid=517472722&single=true&output=csv", eventBannerUrl: "https://info.moengage.com/hubfs/CES_logo_vertical.png" }
                ];

                for (const event of initialEvents) {
                    const eventId = sanitizeForFirestoreId(event.eventName.toLowerCase().replace(/\s+/g, '-')) + '-' + new Date(event.eventDate).getTime(); 
                    const eventRef = doc(db, "artifacts", appId, "public/data/eventProfiles", eventId);
                    try {
                        const docSnap = await getDoc(eventRef);
                        if (!docSnap.exists()) {
                            await saveEventProfile({ ...event, id: eventId }); 
                        }
                    } catch(e) { console.error("Error checking/saving initial event:", e); }
                }
            }
            await populateEventTiles(); 
        }
                
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();

            enterAppButton.addEventListener('click', async () => {
                const name = userNameInput.value.trim();
                if (name) {
                    await saveUserName(name); 
                    welcomeBackMessage.textContent = `Welcome back, ${name}!`;
                    userNamePrompt.classList.add('hidden');
                    returningUserOptions.classList.remove('hidden');
                } else {
                    showNotification("Please enter your first name.", "error"); 
                }
            });

            viewEventsButton.addEventListener('click', async () => {
                await populateEventTiles();
                showScreen('eventSelection');
            });

            adminControlsLoginButton.addEventListener('click', () => {
                showScreen('adminLogin');
            });
            
            userLogoutButton.addEventListener('click', () => {
                localStorage.removeItem('attendeeAppUserName');
                currentUserNameFromStorage = '';
                userNameInput.value = ''; 
                userNamePrompt.classList.remove('hidden');
                returningUserOptions.classList.add('hidden');
                showScreen('welcome');
            });

            backToWelcomeFromAdminLoginButton.addEventListener('click', () => showScreen('welcome'));
            
            adminLoginSubmitButton.addEventListener('click', () => {
                const username = adminUsernameSelect.value;
                const password = adminPasswordInput.value;
                if (adminUsers[username] && adminUsers[username] === password) {
                    adminPasswordInput.value = ''; 
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showScreen('adminControls');
                } else {
                    showNotification("Invalid admin username or password.", "error"); 
                    adminPasswordInput.value = '';
                }
            });

            adminLogoutButton.addEventListener('click', () => {
                sessionStorage.removeItem('adminLoggedIn');
                showScreen('welcome'); 
            });

            addEventTile.addEventListener('click', () => {
                addEventForm.reset();
                addEventModal.classList.remove('hidden');
            });
            closeAddEventModalButton.addEventListener('click', () => addEventModal.classList.add('hidden'));
            addEventModal.addEventListener('click', (e) => { if(e.target === addEventModal) addEventModal.classList.add('hidden'); });

            submitAddEventButton.addEventListener('click', async () => {
                const eventData = {
                    eventName: document.getElementById('eventName').value.trim(),
                    city: document.getElementById('eventCity').value.trim(),
                    eventDate: document.getElementById('eventDate').value,
                    eventStartTime: document.getElementById('eventStartTime').value,
                    eventEndTime: document.getElementById('eventEndTime').value,
                    eventSheetUrl: document.getElementById('eventSheetUrl').value.trim(),
                    eventBannerUrl: document.getElementById('eventBannerUrl').value.trim(),
                };
                if (Object.values(eventData).some(val => !val)) {
                    showNotification("Please fill all event fields.", "error"); 
                    return;
                }
                submitAddEventButton.disabled = true;
                submitAddEventButton.textContent = 'Submitting...';
                const success = await saveEventProfile(eventData);
                if (success) {
                    showNotification("Event added successfully!", "success"); 
                    addEventModal.classList.add('hidden');
                    await populateEventTiles(); 
                    await populateManageEventsDropdown(); 
                } else {
                    showNotification("Failed to add event. Check console.", "error"); 
                }
                submitAddEventButton.disabled = false;
                submitAddEventButton.textContent = 'Submit Event';
            });

            manageEventsTile.addEventListener('click', async () => {
                await populateManageEventsDropdown();
                manageEventsModal.classList.remove('hidden');
            });
            closeManageEventsModalButton.addEventListener('click', () => manageEventsModal.classList.add('hidden'));
            doneManageEventsButton.addEventListener('click', () => manageEventsModal.classList.add('hidden'));
            manageEventsModal.addEventListener('click', (e) => { if(e.target === manageEventsModal) manageEventsModal.classList.add('hidden'); });

            deleteEventButton.addEventListener('click', async () => {
                const eventIdToDelete = manageEventDropdown.value;
                if (!eventIdToDelete) {
                    showNotification("Please select an event to delete.", "info"); 
                    return;
                }
                await deleteEventProfile(eventIdToDelete);
            });
            
            backToEventSelectionButton.addEventListener('click', async () => {
                currentSelectedEventId = null;
                currentSelectedEventData = null;
                CURRENT_EVENT_GOOGLE_SHEET_URL = '';
                if(pollingTimeoutId) clearTimeout(pollingTimeoutId);
                allAttendees = []; 
                homeScreenTotalAttendeesCount.textContent = '0';
                eventStatusIndicator.classList.add('hidden');
                await populateEventTiles();
                showScreen('eventSelection');
            });
                        
            searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFiltersAndSearch(); });
            filterButton.addEventListener('click', openFilterModal);
            metricsButton.addEventListener('click', openMetricsModal);
                        
            demoRequestedButton.addEventListener('click', async () => {
                if (currentAttendeeForDemo) {
                    await toggleDemoRequest(currentAttendeeForDemo);
                }
            });
            
            generateIcebreakerButton.addEventListener('click', () => {
                if(currentAttendeeForDemo) {
                    generateIcebreaker(currentAttendeeForDemo);
                }
            });
                        
            closeAttendeeModalButton.addEventListener('click', closeAttendeeDetailModal);
            closeAttendeeModalFooterButton.addEventListener('click', closeAttendeeDetailModal);
            attendeeModal.addEventListener('click', (e) => { if (e.target === attendeeModalContent || attendeeModalContent.contains(e.target)) return; closeAttendeeDetailModal(); });
                        
            closeFilterModalButton.addEventListener('click', closeFilterModal);
            filterModal.addEventListener('click', (e) => { if (e.target === filterModal.querySelector('.bg-white')) return; if (e.target === filterModal) closeFilterModal(); }); 
                        
            closeMetricsModalButton.addEventListener('click', closeMetricsModal);
            closeMetricsModalFooterButton.addEventListener('click', closeMetricsModal);
            metricsModal.addEventListener('click', (e) => { if (e.target === metricsModal.querySelector('.bg-white')) return; if (e.target === metricsModal) closeMetricsModal(); });

            downloadDemoRequestsCsvButton.addEventListener('click', () => {
                const demoRequestedAttendees = allAttendees.filter(att => att.demoRequested === true);
                if (demoRequestedAttendees.length > 0) {
                    downloadCSV(demoRequestedAttendees);
                } else {
                    showNotification("No demo requests to download.", "info"); 
                }
            });

            applyFiltersButton.addEventListener('click', () => {
                currentFilters.type = filterType.value; 
                currentFilters.focusAccount = filterFocusAccount.value;
                currentFilters.onGroundAE = filterAE.value; 
                currentFilters.onGroundSDR = filterSDR.value; 
                applyFiltersAndSearch(); closeFilterModal();
            });
            clearFiltersButton.addEventListener('click', () => {
                filterType.value = 'All'; 
                filterFocusAccount.value = 'All';
                filterAE.value = 'All'; 
                filterSDR.value = 'All'; 
                currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
                applyFiltersAndSearch(); 
                closeFilterModal();
            });
            retryFetchButton.addEventListener('click', () => { showError(false); fetchAttendees(); });
        });
    </script>
</body>
</html>
