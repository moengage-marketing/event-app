<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Attendee Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Basic styling for modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Ensure table headers are sticky if table scrolls */
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* Tailwind gray-50 */
            z-index: 10;
        }
        /* Prevent text selection on click for better UX on interactive elements */
        .no-select {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Edge, Opera and Firefox */
        }
        /* Ensure images don't overflow their containers */
        img {
            max-width: 100%;
            height: auto;
        }
        .copy-feedback {
            font-size: 0.75rem; /* text-xs */
            color: #10B981; /* green-600 */
            margin-left: 8px; /* ml-2 */
            display: inline-block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px; /* Adjust as needed */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 350px; /* Max height */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .chart-container {
                height: 350px;
            }
        }
        .side-by-side-charts .chart-container {
             max-width: 100%; /* Allow them to fill their flex item */
        }
        #transcriptArea {
            min-height: 100px;
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 8px;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #f9fafb; /* gray-50 */
        }

    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 text-center">
            <img src="https://info.moengage.com/hubfs/Growth%20Summit%20logo.png" 
                 alt="Event Banner" 
                 class="max-w-full h-auto mx-auto rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/800x200/cccccc/333333?text=Event+Banner+Not+Found';">
        </header>

        <main class="bg-white p-6 rounded-lg shadow-xl">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700 mb-2 text-center">Checked-in Attendees</h1>
            <p class="text-sm text-gray-500 mb-6 text-center">Refresh this page regularly</p>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 md:space-x-4">
                <button id="filterButton"
                        style="background-color: #0abc58;" class="w-full md:w-auto order-1 md:order-none hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" />
                    </svg>
                    Filters
                </button>
                <div class="relative w-full md:flex-grow order-none md:order-none">
                    <input type="text" id="searchInput"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                           placeholder="Search by name, company, or job title...">
                    <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <button id="metricsButton"
                        class="w-full md:w-auto order-2 md:order-none bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Metrics
                </button>
            </div>

            <div id="loadingSpinner" class="text-center py-10 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                <p class="text-gray-600 mt-2">Loading attendees...</p>
            </div>
            
            <div id="errorMessage" class="text-center py-10 hidden bg-red-100 text-red-700 p-4 rounded-lg">
                <p id="errorText"></p>
                <button id="retryFetchButton" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Retry
                </button>
            </div>

            <div id="attendeesTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm table-fixed">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="w-[20%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="w-[40%] px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
                <p id="noAttendeesMessage" class="text-center text-gray-500 py-10 hidden">No attendees checked in yet.</p>
            </div>
        </main>

        <div id="attendeeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Details</h3>
                    <button id="closeAttendeeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalBody" class="p-6 space-y-3"></div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                     <button id="captureContextButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Capture On-ground Context</button>
                     <button id="closeAttendeeModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="filterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Filter Attendees</h3>
                    <button id="closeFilterModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="filterType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Prospect">Prospect</option> <option value="Partner">Partner</option> <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterFocusAccount" class="block text-sm font-medium text-gray-700 mb-1">Focus Account</label>
                        <select id="filterFocusAccount" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option> <option value="Yes">Yes</option> <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAE" class="block text-sm font-medium text-gray-700 mb-1">On-ground AE</label>
                        <select id="filterAE" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All AEs</option></select>
                    </div>
                    <div>
                        <label for="filterSDR" class="block text-sm font-medium text-gray-700 mb-1">On-ground SDR</label>
                         <select id="filterSDR" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All SDRs</option></select>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="clearFiltersButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">Clear Filters</button>
                    <button id="applyFiltersButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Apply Filters</button>
                </div>
            </div>
        </div>
        
        <div id="metricsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Attendee Metrics</h3>
                    <button id="closeMetricsModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700">Total Checked-in: <span id="totalAttendeesCount" class="text-blue-600">0</span></h4>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0 side-by-side-charts">
                        <div class="md:w-1/2 chart-container">
                             <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees per SDR</h4>
                            <canvas id="sdrChart"></canvas>
                        </div>
                        <div class="md:w-1/2 chart-container">
                            <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees per AE</h4>
                            <canvas id="aeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Attendees by Type</h4>
                        <canvas id="attendeeTypeChart"></canvas>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
                     <button id="closeMetricsModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="voiceContextModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Capture On-ground Context</h3>
                    <button id="closeVoiceContextModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <p id="voiceStatusMessage" class="text-sm text-gray-600">Click "Start Recording" to begin.</p>
                    <div id="transcriptArea" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 min-h-[100px]">
                        </div>
                    <div class="flex space-x-2 mt-2">
                        <button id="startRecordingButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Start Recording</button>
                        <button id="stopRecordingButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Stop Recording</button>
                        <button id="restartRecordingButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Restart</button>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                     <button id="submitContextButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" disabled>Submit Context</button>
                     <button id="closeVoiceContextModalFooterButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>


    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-cx__1LPjJe0y47F10LZwWrOmHISaw0V3L4zaTIVRHp5jaDDK4FqKuwwd2Uatu1SEYx2f-lllbao0/pub?gid=943729267&single=true&output=csv';
        const POLLING_INTERVAL = 30000; 
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbybv6xiBVCdEwhMrxyzl8ghP2ljWZseIo2u_uhXbum8fJX4Yih71bP1PwcrbPu-EUSB/exec';


        const searchInput = document.getElementById('searchInput');
        const filterButton = document.getElementById('filterButton');
        const metricsButton = document.getElementById('metricsButton');
        const attendeesTableBody = document.getElementById('attendeesTableBody');
        const noAttendeesMessage = document.getElementById('noAttendeesMessage');
        
        const attendeeModal = document.getElementById('attendeeModal');
        const modalBody = document.getElementById('modalBody');
        const closeAttendeeModalButton = document.getElementById('closeAttendeeModalButton');
        const closeAttendeeModalFooterButton = document.getElementById('closeAttendeeModalFooterButton');
        const captureContextButton = document.getElementById('captureContextButton');

        const filterModal = document.getElementById('filterModal');
        const closeFilterModalButton = document.getElementById('closeFilterModalButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const filterType = document.getElementById('filterType');
        const filterFocusAccount = document.getElementById('filterFocusAccount');
        const filterAE = document.getElementById('filterAE'); 
        const filterSDR = document.getElementById('filterSDR'); 

        const metricsModal = document.getElementById('metricsModal');
        const closeMetricsModalButton = document.getElementById('closeMetricsModalButton');
        const closeMetricsModalFooterButton = document.getElementById('closeMetricsModalFooterButton');
        const totalAttendeesCountEl = document.getElementById('totalAttendeesCount');
        const sdrChartCanvas = document.getElementById('sdrChart');
        const aeChartCanvas = document.getElementById('aeChart');
        const attendeeTypeChartCanvas = document.getElementById('attendeeTypeChart');

        const voiceContextModal = document.getElementById('voiceContextModal');
        const closeVoiceContextModalButton = document.getElementById('closeVoiceContextModalButton');
        const closeVoiceContextModalFooterButton = document.getElementById('closeVoiceContextModalFooterButton');
        const voiceStatusMessage = document.getElementById('voiceStatusMessage');
        const transcriptArea = document.getElementById('transcriptArea');
        const startRecordingButton = document.getElementById('startRecordingButton');
        const stopRecordingButton = document.getElementById('stopRecordingButton');
        const restartRecordingButton = document.getElementById('restartRecordingButton');
        const submitContextButton = document.getElementById('submitContextButton');


        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryFetchButton = document.getElementById('retryFetchButton');
        const attendeesTableContainer = document.getElementById('attendeesTableContainer');

        let allAttendees = [];
        let currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
        let currentSearchTerm = '';
        let currentAttendeeForContext = null; 

        let sdrChartInstance = null;
        let aeChartInstance = null;
        let attendeeTypeChartInstance = null;

        let recognition = null;
        let finalTranscript = '';
        let isRecording = false;

        const headerMapping = {
            'First Name': 'firstName', 'Last Name': 'lastName', 'Email': 'email', 'Phone': 'phone',
            'Company': 'company', 'Job Title': 'jobTitle', 'Type': 'type', 
            'Focus Account': 'focusAccount', 'On-ground AE': 'onGroundAE', 'On-ground SDR': 'onGroundSDR',
            'Notes': 'notes', 'On-ground Context': 'onGroundContext'
        };
        const expectedHeaders = Object.keys(headerMapping);

        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && (i === 0 || line[i-1] !== '\\')) { 
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') { current += '"'; i++; } 
                    else { inQuotes = !inQuotes; }
                } else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } 
                else { current += char; }
            }
            result.push(current.trim());
            return result.map(value => value.replace(/^"|"$/g, '').replace(/""/g, '"'));
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); 
            if (lines.length === 0) return [];
            const rawHeaders = parseCSVLine(lines[0]); const data = [];
            const actualHeaders = rawHeaders.map(h => h.trim());
            
            const missingHeaders = expectedHeaders.filter(eh => !actualHeaders.includes(eh) && eh !== 'On-ground Context'); 
            if (missingHeaders.length > 0) {
                 console.warn('CSV headers missing/mismatched. Expected (excluding On-ground Context if new):', missingHeaders, 'Actual:', actualHeaders);
            }

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; 
                const values = parseCSVLine(lines[i]); const entry = {}; let isEmptyRow = true; 
                const numVals = Math.min(values.length, actualHeaders.length);
                for(let j = 0; j < numVals; j++) {
                    const header = actualHeaders[j];
                    const mappedKey = headerMapping[header.trim()] || header.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); 
                    entry[mappedKey] = values[j] || '';
                    if (values[j] && values[j].trim() !== '') isEmptyRow = false;
                }
                if (!isEmptyRow) data.push(entry);
            }
            return data;
        }
        
        function populateFilterDropdowns(attendees) {
            const uniqueAEs = new Set(); const uniqueSDRs = new Set();
            attendees.forEach(att => {
                if (att.onGroundAE && att.onGroundAE.trim() !== '') uniqueAEs.add(att.onGroundAE.trim());
                if (att.onGroundSDR && att.onGroundSDR.trim() !== '') uniqueSDRs.add(att.onGroundSDR.trim());
            });
            filterAE.innerHTML = '<option value="All">All AEs</option>'; 
            Array.from(uniqueAEs).sort().forEach(ae => { const opt = document.createElement('option'); opt.value = ae; opt.textContent = ae; filterAE.appendChild(opt); });
            filterSDR.innerHTML = '<option value="All">All SDRs</option>'; 
            Array.from(uniqueSDRs).sort().forEach(sdr => { const opt = document.createElement('option'); opt.value = sdr; opt.textContent = sdr; filterSDR.appendChild(opt); });
        }

        async function fetchAttendees() {
            showLoading(true); showError(false); let fetchSucceeded = false;
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL + `&t=${new Date().getTime()}`); 
                if (!response.ok) {
                    let errMsg = `HTTP error! Status: ${response.status}.`;
                    switch (response.status) {
                        case 400: errMsg += " Bad Request. Check Sheet ID/GID."; break;
                        case 401: case 403: errMsg += " Unauthorized/Forbidden. Check Sheet permissions."; break;
                        case 404: errMsg += " Not Found. Verify Sheet ID/GID."; break;
                        default: errMsg += " Unexpected error.";
                    }
                    throw new Error(errMsg);
                }
                const csvText = await response.text();
                let parsedAtt = (csvText.trim() === '') ? [] : parseCSV(csvText);
                allAttendees = parsedAtt.filter(att => (att.firstName && att.firstName.trim() !== '') || (att.lastName && att.lastName.trim() !== '') || (att.company && att.company.trim() !== '') || (att.jobTitle && att.jobTitle.trim() !== '') );
                populateFilterDropdowns(allAttendees); 
                fetchSucceeded = true;
            } catch (error) { 
                console.error('Error fetching attendees:', error);
                let userFriendlyMessage = `Failed to load attendee data: ${error.message}.`;
                if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                    userFriendlyMessage += ' This often indicates a network issue or that the Google Sheet URL is inaccessible. Please check your internet connection and ensure the Google Sheet is correctly published and publicly accessible via its CSV link.';
                }
                showError(userFriendlyMessage);
            } finally { 
                showLoading(false); 
                if (fetchSucceeded) {
                    applyFiltersAndSearch(); 
                }
            }
        }

        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            attendeesTableContainer.classList.toggle('hidden', isLoading);
            noAttendeesMessage.classList.toggle('hidden', isLoading); 
        }
        function showError(show, message = '') {
            errorText.textContent = message; errorMessage.classList.toggle('hidden', !show);
            attendeesTableContainer.classList.toggle('hidden', show); 
            noAttendeesMessage.classList.toggle('hidden', show); 
        }

        function renderTable(attendeesToRender) {
            attendeesTableBody.innerHTML = ''; 
            const tableHeader = attendeesTableContainer.querySelector('table thead');
            if (attendeesToRender.length === 0) { noAttendeesMessage.classList.remove('hidden'); tableHeader.classList.add('hidden'); } 
            else {
                noAttendeesMessage.classList.add('hidden'); tableHeader.classList.remove('hidden'); 
                attendeesToRender.forEach((attendee, index) => {
                    const row = attendeesTableBody.insertRow();
                    row.className = 'hover:bg-gray-100 cursor-pointer transition-colors no-select';
                    const originalAttendeeRef = allAttendees.find(orig => orig.email === attendee.email && orig.firstName === attendee.firstName && orig.lastName === attendee.lastName);
                    const dataId = originalAttendeeRef ? allAttendees.indexOf(originalAttendeeRef) : index; 
                    row.setAttribute('data-id', dataId); 
                    const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
                    const cellName = row.insertCell();
                    const cellCompany = row.insertCell();
                    const cellTitle = row.insertCell();

                    cellName.textContent = fullName || 'N/A';
                    cellCompany.textContent = attendee.company || 'N/A';
                    cellTitle.textContent = attendee.jobTitle || 'N/A';

                    Array.from(row.cells).forEach(cell => {
                        cell.className = 'px-6 py-4 text-sm text-gray-700 break-words';
                    });
                    
                    row.addEventListener('click', () => openAttendeeDetailModal(attendee));
                });
            }
        }
        
        function copyToClipboard(text, feedbackElement) {
            const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); if(feedbackElement) { feedbackElement.textContent = 'Copied!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            catch (err) { console.error('Copy failed: ', err); if(feedbackElement) { feedbackElement.textContent = 'Copy failed!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000);}}
            document.body.removeChild(ta);
        }

        function openAttendeeDetailModal(attendee) {
            currentAttendeeForContext = attendee; 
            modalBody.innerHTML = ''; 
            const fullName = `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim();
            const createDetailRow = (label, value, type = 'text') => {
                if (value && value.trim() !== '') { 
                    const div = document.createElement('div'); div.className = 'grid grid-cols-3 gap-2 items-center';
                    const lbl = document.createElement('p'); lbl.className = 'text-sm font-medium text-gray-500 col-span-1 break-words'; lbl.textContent = label + ':'; div.appendChild(lbl);
                    const valCont = document.createElement('div'); valCont.className = 'text-sm text-gray-900 col-span-2 break-words flex items-center';
                    if (type === 'tel' && value) { const a = document.createElement('a'); a.href = `tel:${value.replace(/\s+/g, '')}`; a.textContent = value; a.className = 'text-blue-600 hover:text-blue-800 hover:underline'; valCont.appendChild(a); } 
                    else if (type === 'email' && value) {
                        const emSpan = document.createElement('span'); emSpan.textContent = value; emSpan.className = 'text-blue-600 hover:text-blue-800 hover:underline cursor-pointer';
                        const fbSpan = document.createElement('span'); fbSpan.className = 'copy-feedback';
                        emSpan.addEventListener('click', () => copyToClipboard(value, fbSpan));
                        valCont.appendChild(emSpan); valCont.appendChild(fbSpan);
                    } else { const p = document.createElement('p'); p.innerHTML = value.replace(/\n/g, '<br>'); valCont.appendChild(p); } 
                    div.appendChild(valCont); modalBody.appendChild(div);
                }
            };
            createDetailRow('Full Name', fullName); createDetailRow('Email', attendee.email, 'email'); createDetailRow('Phone', attendee.phone, 'tel');
            createDetailRow('Company', attendee.company); createDetailRow('Job Title', attendee.jobTitle); createDetailRow('Type', attendee.type);
            createDetailRow('Focus Account', attendee.focusAccount); createDetailRow('On-ground AE', attendee.onGroundAE); createDetailRow('On-ground SDR', attendee.onGroundSDR);
            createDetailRow('Notes', attendee.notes);
            createDetailRow('On-ground Context', attendee.onGroundContext); 
            attendeeModal.classList.remove('hidden');
        }
        function closeAttendeeDetailModal() { attendeeModal.classList.add('hidden'); currentAttendeeForContext = null; }
        
        function openFilterModal() {
            filterType.value = currentFilters.type; filterFocusAccount.value = currentFilters.focusAccount;
            filterAE.value = currentFilters.onGroundAE; filterSDR.value = currentFilters.onGroundSDR; 
            filterModal.classList.remove('hidden');
        }
        function closeFilterModal() { filterModal.classList.add('hidden'); }

        function createOrUpdateChart(chartInstance, canvasElement, chartType, data, options) {
            if (chartInstance) { chartInstance.destroy(); }
            return new Chart(canvasElement, { type: chartType, data: data, options: options });
        }

        function openMetricsModal() {
            totalAttendeesCountEl.textContent = allAttendees.length;
            const sdrCounts = {}; const aeCounts = {};
            const typeCounts = { 'Prospect': 0, 'Partner': 0, 'Customer': 0 };

            allAttendees.forEach(attendee => {
                const sdr = attendee.onGroundSDR?.trim();
                const ae = attendee.onGroundAE?.trim();
                const type = attendee.type?.trim();
                if (sdr) sdrCounts[sdr] = (sdrCounts[sdr] || 0) + 1;
                if (ae) aeCounts[ae] = (aeCounts[ae] || 0) + 1;
                if (type && typeCounts.hasOwnProperty(type)) typeCounts[type]++;
            });

            const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false } }, animation: false };
            
            const sdrChartData = { labels: Object.keys(sdrCounts), datasets: [{ data: Object.values(sdrCounts), backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] };
            sdrChartInstance = createOrUpdateChart(sdrChartInstance, sdrChartCanvas, 'bar', sdrChartData, chartOptions);

            const aeChartData = { labels: Object.keys(aeCounts), datasets: [{ data: Object.values(aeCounts), backgroundColor: 'rgba(255, 159, 64, 0.6)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }] };
            aeChartInstance = createOrUpdateChart(aeChartInstance, aeChartCanvas, 'bar', aeChartData, chartOptions);
            
            const attendeeTypeChartData = { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 205, 86, 0.6)'], borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 205, 86, 1)'], borderWidth: 1 }] };
            attendeeTypeChartInstance = createOrUpdateChart(attendeeTypeChartInstance, attendeeTypeChartCanvas, 'bar', attendeeTypeChartData, chartOptions);

            metricsModal.classList.remove('hidden');
        }
        function closeMetricsModal() { metricsModal.classList.add('hidden'); }

        function applyFiltersAndSearch() {
            let filtered = [...allAttendees]; 
            filtered = filtered.filter(att => 
                (currentFilters.type === 'All' || (att.type && att.type.toLowerCase() === currentFilters.type.toLowerCase())) &&
                (currentFilters.focusAccount === 'All' || (att.focusAccount && att.focusAccount.toLowerCase() === currentFilters.focusAccount.toLowerCase())) &&
                (currentFilters.onGroundAE === 'All' || (att.onGroundAE && att.onGroundAE === currentFilters.onGroundAE)) && 
                (currentFilters.onGroundSDR === 'All' || (att.onGroundSDR && att.onGroundSDR === currentFilters.onGroundSDR))   
            );
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(att =>
                    (`${att.firstName || ''} ${att.lastName || ''}`.toLowerCase().includes(searchTermLower)) ||
                    ((att.company || '').toLowerCase().includes(searchTermLower)) ||
                    ((att.jobTitle || '').toLowerCase().includes(searchTermLower))
                );
            }
            filtered.sort((a, b) => {
                const nameA = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
                const nameB = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
                if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0;
            });
            if (!loadingSpinner.classList.contains('hidden') || !errorMessage.classList.contains('hidden')) {} 
            else { attendeesTableContainer.classList.remove('hidden'); renderTable(filtered); }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                voiceStatusMessage.textContent = 'Speech recognition is not supported in this browser. Please use Chrome or Edge.';
                startRecordingButton.disabled = true;
                return null;
            }
            const rec = new SpeechRecognition();
            rec.continuous = true;
            rec.interimResults = true;
            rec.lang = 'en-US';

            rec.onstart = () => {
                isRecording = true;
                voiceStatusMessage.textContent = 'Recording... Speak now.';
                startRecordingButton.classList.add('hidden');
                stopRecordingButton.classList.remove('hidden');
                restartRecordingButton.classList.remove('hidden');
                submitContextButton.disabled = true;
            };

            rec.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                transcriptArea.textContent = finalTranscript + interimTranscript;
            };

            rec.onerror = (event) => {
                console.error('Speech recognition error:', event.error, event.message);
                let userMessage = `Error: ${event.error}.`;
                if (event.error === 'not-allowed') {
                    userMessage = 'Microphone permission denied. Please check your browser\'s site settings to allow microphone access for this page, then refresh and try again.';
                } else if (event.error === 'no-speech') {
                     userMessage = 'No speech detected. Please ensure your microphone is working and try speaking clearly.';
                } else if (event.error === 'audio-capture') {
                    userMessage = 'Audio capture failed. Please ensure your microphone is properly connected and not in use by another application.';
                } else if (event.error === 'network') {
                    userMessage = 'Network error during speech recognition. Please check your internet connection.';
                } else {
                    userMessage = `Speech recognition error: ${event.error}. Please try again.`;
                }
                voiceStatusMessage.textContent = userMessage;
                isRecording = false;
                startRecordingButton.classList.remove('hidden');
                stopRecordingButton.classList.add('hidden');
                restartRecordingButton.classList.add('hidden');
                submitContextButton.disabled = true;
            };

            rec.onend = () => {
                isRecording = false;
                if (finalTranscript.trim() !== '') { 
                    submitContextButton.disabled = false;
                }
                 if(!stopRecordingButton.classList.contains('hidden')) { 
                    voiceStatusMessage.textContent = 'Recording stopped. Click Submit or Restart.';
                 } else if (startRecordingButton.classList.contains('hidden')) { 
                    voiceStatusMessage.textContent = 'Recording ended. Click Submit or Restart.';
                 }
            };
            return rec;
        }
        
        function startVoiceCapture() {
            if (!currentAttendeeForContext) return;
            finalTranscript = '';
            transcriptArea.textContent = '';
            voiceStatusMessage.textContent = 'Initializing... Please allow microphone access if prompted.';
            submitContextButton.disabled = true;
            
            if (!recognition) { 
                recognition = initializeSpeechRecognition();
            }

            if (recognition) { 
                try {
                    if (!isRecording) {
                        recognition.start();
                    } else {
                        console.log("Recognition already started.");
                    }
                } catch(e) {
                    console.error("Error starting recognition:", e);
                    voiceStatusMessage.textContent = "Could not start recording. Check permissions and try again.";
                    isRecording = false;
                    startRecordingButton.classList.remove('hidden');
                    stopRecordingButton.classList.add('hidden');
                    restartRecordingButton.classList.add('hidden');
                }
            } else {
                voiceStatusMessage.textContent = 'Speech recognition is not available on this browser.';
                startRecordingButton.disabled = true;
            }
        }

        function stopVoiceCapture() {
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false; 
                voiceStatusMessage.textContent = 'Recording stopped. Ready to submit or restart.';
                stopRecordingButton.classList.add('hidden');
                startRecordingButton.classList.remove('hidden'); 
            }
        }
        
        function restartVoiceCapture() {
            if (recognition && isRecording) {
                recognition.stop(); 
            }
            finalTranscript = '';
            transcriptArea.textContent = '';
            voiceStatusMessage.textContent = 'Restarting...';
            submitContextButton.disabled = true;
            setTimeout(() => {
                 startVoiceCapture();
            }, 100);
        }

        async function submitContextToSheet() {
            if (!currentAttendeeForContext || !currentAttendeeForContext.email) {
                alert('Error: Attendee details not found.');
                return;
            }
            if (finalTranscript.trim() === '') {
                alert('No context recorded to submit.');
                return;
            }
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) {
                alert('Developer: Google Apps Script URL not configured. Please update the GOOGLE_APPS_SCRIPT_URL constant in the script.');
                voiceStatusMessage.textContent = 'Submission endpoint not configured.';
                return;
            }

            voiceStatusMessage.textContent = 'Submitting...';
            submitContextButton.disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentAttendeeForContext.email,
                        context: finalTranscript.trim()
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('Submission to Apps Script failed with status:', response.status, response.statusText, 'Response body:', errorBody);
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}. Check console for Apps Script response.`);
                }
                
                const result = await response.json();
                if (result.status === 'success') {
                    voiceStatusMessage.textContent = 'Your context will be transcribed in a couple of hours.'; 
                    setTimeout(() => {
                        closeVoiceContextModal();
                        fetchAttendees(); 
                    }, 2000);
                } else {
                    console.error('Apps Script reported an error:', result.message);
                    throw new Error(result.message || 'Failed to submit context. Server indicated an error.');
                }
            } catch (error) {
                console.error('Error submitting context to Apps Script:', error);
                let userFriendlyError = `Submission failed: ${error.message}.`;
                 if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                    userFriendlyError += ' This could be a network issue, CORS problem, or an issue with the Apps Script URL/deployment (e.g., not deployed correctly, wrong URL, or script error).';
                }
                userFriendlyError += ' Please check the browser console for more technical details and ensure the Apps Script is deployed correctly with "Anyone" access.';
                voiceStatusMessage.textContent = userFriendlyError;
                submitContextButton.disabled = false; 
            }
        }


        function openVoiceContextModal() {
            if (!currentAttendeeForContext) {
                alert("Please select an attendee first by clicking on their row.");
                return;
            }
            voiceStatusMessage.textContent = 'Click "Start Recording" to begin. Allow microphone access if prompted.';
            transcriptArea.textContent = '';
            finalTranscript = '';
            startRecordingButton.classList.remove('hidden');
            stopRecordingButton.classList.add('hidden');
            restartRecordingButton.classList.add('hidden');
            submitContextButton.disabled = true;
            voiceContextModal.classList.remove('hidden');
        }
        function closeVoiceContextModal() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            voiceContextModal.classList.add('hidden');
        }

        
        document.addEventListener('DOMContentLoaded', () => {
            fetchAttendees(); setInterval(fetchAttendees, POLLING_INTERVAL); 
            searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFiltersAndSearch(); });
            filterButton.addEventListener('click', openFilterModal);
            metricsButton.addEventListener('click', openMetricsModal);
            captureContextButton.addEventListener('click', openVoiceContextModal);


            closeAttendeeModalButton.addEventListener('click', closeAttendeeDetailModal);
            closeAttendeeModalFooterButton.addEventListener('click', closeAttendeeDetailModal);
            attendeeModal.addEventListener('click', (e) => { if (e.target === attendeeModal) closeAttendeeDetailModal(); });
            
            closeFilterModalButton.addEventListener('click', closeFilterModal);
            filterModal.addEventListener('click', (e) => { if (e.target === filterModal) closeFilterModal(); });
            
            closeMetricsModalButton.addEventListener('click', closeMetricsModal);
            closeMetricsModalFooterButton.addEventListener('click', closeMetricsModal);
            metricsModal.addEventListener('click', (e) => { if (e.target === metricsModal) closeMetricsModal(); });

            closeVoiceContextModalButton.addEventListener('click', closeVoiceContextModal);
            closeVoiceContextModalFooterButton.addEventListener('click', closeVoiceContextModal);
            voiceContextModal.addEventListener('click', (e) => { if (e.target === voiceContextModal) closeVoiceContextModal(); });

            startRecordingButton.addEventListener('click', startVoiceCapture);
            stopRecordingButton.addEventListener('click', stopVoiceCapture);
            restartRecordingButton.addEventListener('click', restartVoiceCapture);
            submitContextButton.addEventListener('click', submitContextToSheet);


            applyFiltersButton.addEventListener('click', () => {
                currentFilters.type = filterType.value; currentFilters.focusAccount = filterFocusAccount.value;
                currentFilters.onGroundAE = filterAE.value; currentFilters.onGroundSDR = filterSDR.value; 
                applyFiltersAndSearch(); closeFilterModal();
            });
            clearFiltersButton.addEventListener('click', () => {
                filterType.value = 'All'; filterFocusAccount.value = 'All';
                filterAE.value = 'All'; filterSDR.value = 'All'; 
                currentFilters = { type: 'All', focusAccount: 'All', onGroundAE: 'All', onGroundSDR: 'All' };
                applyFiltersAndSearch(); closeFilterModal();
            });
            retryFetchButton.addEventListener('click', () => { showError(false); fetchAttendees(); });
        });
    </script>
</body>
</html>

